"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_util=require("./util");function _createForOfIteratorHelper(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==t.return||t.return()}finally{if(o)throw a}}}}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,i=new Array(r);t<r;t++)i[t]=e[t];return i}var fs=require("fs"),path=require("path"),SingleEntryPlugin=require("webpack/lib/SingleEntryPlugin"),CUSTOM_THEME_PROP_GROUPS=require("./theme/customThemeStyles"),OHOS_THEME_PROP_GROUPS=require("./theme/ohosStyles"),FILE_EXT_NAME=[".js",".css",".jsx",".less",".sass",".scss",".md",".DS_Store",".hml"],red="[31m",reset="[39m",input="",output="",manifestFilePath="",shareThemePath="",internalThemePath="";function copyFile(e,r){try{if(fs.existsSync(e)){var t=path.join(r,"..");fs.existsSync(t)&&fs.statSync(t).isDirectory()||(0,_util.mkDir)(t);var i=path.parse(e),n=addPageEntryObj(),a=i.dir+path.sep+i.name+".hml?entry";for(var s in n)if(n[s]===a)return;if(".json"===i.ext&&(i.dir===shareThemePath||i.dir===internalThemePath)&&themeFileBuild(e,r))return;var o=fs.createReadStream(e),l=fs.createWriteStream(r);o.pipe(l),o.on("close",function(){l.end()})}}catch(r){throw console.error(red,"Failed to build file ".concat(e,"."),reset),r.message}}function circularFile(e,r,t){var i=path.join(e,t),n=path.join(input,"i18n");fs.existsSync(i)&&i!==output&&i!==n&&fs.readdirSync(i).forEach(function(n){var a=path.join(i,n),s=fs.statSync(a);if(s.isFile()){var o=path.basename(a),l=path.extname(a);if(FILE_EXT_NAME.indexOf(l)<0&&".DS_Store"!==o){var c=path.join(r,t,path.basename(n));if(c===path.join(output,"manifest.json"))return;if(fs.existsSync(c)){var u=fs.statSync(c);u.isFile()&&s.size!==u.size&&copyFile(a,c)}else copyFile(a,c)}}else s.isDirectory()&&circularFile(e,r,path.join(t,n))})}var ResourcePlugin=function(){function e(r,t,i){(0,_classCallCheck2.default)(this,e),input=r,output=t,manifestFilePath=i,shareThemePath=path.join(r,"../share/resources/styles"),internalThemePath=path.join(r,"resources/styles")}return(0,_createClass2.default)(e,[{key:"apply",value:function(e){var r=this;e.hooks.beforeCompile.tap("resource Copy",function(){(0,_newArrowCheck2.default)(this,r),circularFile(input,output,""),circularFile(input,output,"../share")}.bind(this)),e.hooks.normalModuleFactory.tap("OtherEntryOptionPlugin",function(){if((0,_newArrowCheck2.default)(this,r),"card"!==process.env.DEVICE_LEVEL)for(var t in addPageEntryObj(),entryObj){if(!e.options.entry[t])new SingleEntryPlugin("",entryObj[t],t).apply(e)}}.bind(this)),e.hooks.done.tap("copyManifest",function(){(0,_newArrowCheck2.default)(this,r),copyManifest(),fs.existsSync(path.join(output,"app.js"))&&fs.utimesSync(path.join(output,"app.js"),new Date,new Date)}.bind(this))}}]),e}();function copyManifest(){copyFile(manifestFilePath,path.join(output,"manifest.json"))}var entryObj={};function addPageEntryObj(){var e=this;if(entryObj={},"page"===process.env.abilityType){var r=readManifest(manifestFilePath).pages;if(void 0===r)throw Error("ERROR: missing pages").message;r.forEach(function(r){(0,_newArrowCheck2.default)(this,e);var t=r,i=path.join(input,t+".hml"),n=process.env.aceSuperVisualPath||"",a=path.join(n,t+".visual"),s=fs.existsSync(i),o=fs.existsSync(a),l=process.env.projectPath;s&&o?console.error("ERROR: "+t+" cannot both have hml && visual"):s?entryObj["./"+r]=path.resolve(l,"./"+t+".hml?entry"):o&&(entryObj["./"+r]=path.resolve(n,"./"+t+".visual?entry"))}.bind(this))}return"true"!==process.env.isPreview&&"rich"===process.env.DEVICE_LEVEL&&loadWorker(entryObj),entryObj}function readManifest(e){var r={};try{if(fs.existsSync(e)){var t=fs.readFileSync(e).toString();r=JSON.parse(t)}else{if(!process.env.aceConfigPath||!fs.existsSync(process.env.aceConfigPath))throw Error("[31mERROR: the manifest.json or config.json is lost.[39m").message;buildManifest(r,process.env.aceConfigPath)}}catch(e){throw Error("[31mERROR: the manifest.json or config.json file format is invalid.[39m").message}return r}function buildManifest(e,r){try{var t=JSON.parse(fs.readFileSync(r).toString()),i=process.env.srcPath;if(e.type=process.env.abilityType,!t.module||!t.module.abilities)throw Error("[31mEERROR: the config.json file miss keyword module || module[abilities].[39m").message;e.pages=getPages(t,i),e.minPlatformVersion=t.app.apiVersion.compatible}catch(e){throw Error("[31mERROR: the config.json file is lost or format is invalid.[39m").message}}function getPages(e,r){var t,i=[],n=_createForOfIteratorHelper(e.module.abilities);try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.srcPath===r){readPages(a,i,e);break}}}catch(e){n.e(e)}finally{n.f()}return i}function readPages(e,r,t){var i,n=this,a=_createForOfIteratorHelper(t.module.js);try{for(a.s();!(i=a.n()).done;){var s=i.value;if(e.name===s.name){s.pages.forEach(function(e){(0,_newArrowCheck2.default)(this,n),r.push(e)}.bind(this));break}}}catch(e){a.e(e)}finally{a.f()}}function loadWorker(e){var r=this,t=path.resolve(input,"workers");if(fs.existsSync(t)){var i=[];readFile(t,i),i.forEach(function(i){if((0,_newArrowCheck2.default)(this,r),/\.js$/.test(i)){var n=path.relative(t,i).replace(/\.js$/,"");e["./workers/"+n]=i}}.bind(this))}}function readFile(e,r){var t=this;try{fs.readdirSync(e).forEach(function(i){(0,_newArrowCheck2.default)(this,t);var n=path.join(e,i);fs.statSync(n).isDirectory()?readFile(n,r):r.push(n)}.bind(this))}catch(e){console.error(e.message)}}function themeFileBuild(e,r){if(fs.existsSync(e)){var t=JSON.parse(fs.readFileSync(e)),i={};if(t&&t.style){i.style={};var n=t.style;return Object.keys(n).forEach(function(e){var r=CUSTOM_THEME_PROP_GROUPS[e],t=OHOS_THEME_PROP_GROUPS[e];t?i.style[t]=n[e]:r?i.style[r]=n[e]:i.style[e]=n[e]}),fs.writeFileSync(r,JSON.stringify(i,null,2)),!0}}return!1}module.exports=ResourcePlugin;