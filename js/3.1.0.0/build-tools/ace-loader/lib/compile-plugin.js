"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_Compilation=_interopRequireDefault(require("webpack/lib/Compilation")),_JavascriptModulesPlugin=_interopRequireDefault(require("webpack/lib/javascript/JavascriptModulesPlugin")),_CachedSource=_interopRequireDefault(require("webpack-sources/lib/CachedSource")),_ConcatSource=_interopRequireDefault(require("webpack-sources/lib/ConcatSource")),_util=require("./util"),_this5=void 0;function _createForOfIteratorHelper(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var o=0,n=function(){};return{s:n,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==t.return||t.return()}finally{if(s)throw i}}}}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,o=new Array(r);t<r;t++)o[t]=e[t];return o}var mStats,fs=require("fs"),path=require("path"),mErrorCount=0,mWarningCount=0,isShowError=!0,isShowWarning=!0,isShowNote=!0,warningCount=0,noteCount=0,errorCount=0,GLOBAL_COMMON_MODULE_CACHE='\nglobalThis["__common_module_cache__"] = globalThis["__common_module_cache__"] || {};\nglobalThis["webpackChunkace_loader"].forEach((item)=> {\n  Object.keys(item[1]).forEach((element) => {\n    globalThis["__common_module_cache__"][element] = null;\n  })\n});',ResultStates=function(){function e(r){(0,_classCallCheck2.default)(this,e),this.options=r}return(0,_createClass2.default)(e,[{key:"apply",value:function(e){var r=this,t=this.options.build,o=new Set;e.hooks.compilation.tap("toFindModule",function(e){var t=this;(0,_newArrowCheck2.default)(this,r),e.hooks.buildModule.tap("findModule",function(e){if((0,_newArrowCheck2.default)(this,t),/node_modules/.test(e.context)){var r=e.context.substr(0,e.context.indexOf("node_modules")),n=e.context.replace(r,"").replace("node_modules"+path.sep,""),i=n.substr(0,n.indexOf(path.sep)),a=path.resolve(r,"node_modules",i,"src","js","share");fs.existsSync(a)&&o.add(a)}}.bind(this))}.bind(this)),e.hooks.afterCompile.tap("copyFindModule",function(){(0,_newArrowCheck2.default)(this,r);var e,n=_createForOfIteratorHelper(o);try{for(n.s();!(e=n.n()).done;){var i=e.value;(0,_util.circularFile)(i,path.resolve(t,"../share"))}}catch(e){n.e(e)}finally{n.f()}}.bind(this)),e.hooks.done.tap("Result States",function(e){(0,_newArrowCheck2.default)(this,r),warningCount=0,noteCount=0,errorCount=0,(mStats=e).compilation.errors&&(mErrorCount=mStats.compilation.errors.length),mStats.compilation.warnings&&(mWarningCount=mStats.compilation.warnings.length),"false"===process.env.error&&(isShowError=!1),"false"===process.env.warning&&(isShowWarning=!1),"false"===process.env.note&&(isShowNote=!1),printResult(t)}.bind(this)),e.hooks.compilation.tap("CommonAsset",function(e){var t=this;(0,_newArrowCheck2.default)(this,r),e.hooks.processAssets.tap({name:"GLOBAL_COMMON_MODULE_CACHE",stage:_Compilation.default.PROCESS_ASSETS_STAGE_ADDITIONS},function(e){(0,_newArrowCheck2.default)(this,t),e["commons.js"]?e["commons.js"]=new _CachedSource.default(new _ConcatSource.default(e["commons.js"],GLOBAL_COMMON_MODULE_CACHE)):e["vendors.js"]&&(e["vendors.js"]=new _CachedSource.default(new _ConcatSource.default(e["vendors.js"],GLOBAL_COMMON_MODULE_CACHE)))}.bind(this))}.bind(this)),e.hooks.compilation.tap("Require",function(e){var t=this;(0,_newArrowCheck2.default)(this,r),_JavascriptModulesPlugin.default.getCompilationHooks(e).renderRequire.tap("renderRequire",function(e){return(0,_newArrowCheck2.default)(this,t),'var commonCachedModule = globalThis["__common_module_cache__"] ? globalThis["__common_module_cache__"][moduleId]: null;\nif (commonCachedModule) { return commonCachedModule.exports; }\n'+e.replace("// Execute the module function",'if (globalThis["__common_module_cache__"] && moduleId.indexOf("?name=") < 0 && Object.keys(globalThis["__common_module_cache__"]).indexOf(moduleId) >= 0) {\n  globalThis["__common_module_cache__"][moduleId] = module;\n}')}.bind(this))}.bind(this))}}]),e}(),red="[31m",yellow="[33m",blue="[34m",reset="[39m",writeError=function(e,r){var t=this;(0,_newArrowCheck2.default)(this,_this5),fs.writeFile(path.resolve(e,"compile_error.log"),r,function(e){if((0,_newArrowCheck2.default)(this,t),e)return console.error(e)}.bind(this))}.bind(void 0);function printResult(e){if(printWarning(),printError(e),errorCount+warningCount+noteCount>0){var r,t={};errorCount>0?(t.ERROR=errorCount,r="FAIL "):r="SUCCESS ",warningCount>0&&(t.WARN=warningCount),noteCount>0&&(t.NOTE=noteCount),console.log(blue,"COMPILE RESULT:"+r+JSON.stringify(t),reset)}else console.log(blue,"COMPILE RESULT:SUCCESS ",reset)}function printWarning(){if(mWarningCount>0){for(var e=mStats.compilation.warnings,r=e.length,t=0;t<r;t++){var o=e[t].message;null!==o.match(/noteStart(([\s\S])*)noteEnd/)?(noteCount++,isShowNote&&console.info(" "+o.match(/noteStart(([\s\S])*)noteEnd/)[1].trim(),reset,"\n")):null!==o.match(/warnStart(([\s\S])*)warnEnd/)&&(warningCount++,isShowWarning&&console.warn(yellow,o.match(/warnStart(([\s\S])*)warnEnd/)[1].trim(),reset,"\n"))}mWarningCount>r&&(warningCount=warningCount+mWarningCount-r)}}function printError(e){if(mErrorCount>0){var r=mStats.compilation.errors,t=r.length;if(isShowError){for(var o="",n=0;n<t;n++)if(r[n]){var i=r[n].message;if(i){if(null!==i.match(/errorStart(([\s\S])*)errorEnd/)){var a=i.match(/errorStart(([\s\S])*)errorEnd/)[1];console.error(red,a.trim(),reset,"\n")}else!function(){var e=this,r="";i.split("\n").forEach(function(t){(0,_newArrowCheck2.default)(this,e),/^at/.test(t.trim())||(r=r+t+"\n")}.bind(this)),console.error(red,r,reset,"\n")}();errorCount++,o+=i}}writeError(e,o)}}}module.exports=ResultStates;