"use strict";var watchCSSFiles,resourcesPath,sharePath,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_newArrowCheck2=_interopRequireDefault(require("@babel/runtime/helpers/newArrowCheck")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_util=require("./util"),fs=require("fs"),path=require("path"),SingleEntryPlugin=require("webpack/lib/SingleEntryPlugin"),CUSTOM_THEME_PROP_GROUPS=require("./theme/customThemeStyles"),OHOS_THEME_PROP_GROUPS=require("./theme/ohosStyles"),FILE_EXT_NAME=[".js",".css",".jsx",".less",".sass",".scss",".md",".DS_Store",".hml",".json"],red="[31m",reset="[39m",input="",output="",manifestFilePath="",shareThemePath="",internalThemePath="";function copyFile(e,t){try{if(fs.existsSync(e)){var r=path.join(t,"..");fs.existsSync(r)&&fs.statSync(r).isDirectory()||(0,_util.mkDir)(r);var s=path.parse(e),i=addPageEntryObj(),n=s.dir+path.sep+s.name+".hml?entry";for(var a in i)if(i[a]===n)return;if(".json"===s.ext&&(s.dir===shareThemePath||s.dir===internalThemePath)&&themeFileBuild(e,t))return;var o=fs.createReadStream(e),c=fs.createWriteStream(t);o.pipe(c),o.on("close",function(){c.end()})}}catch(t){throw console.error(red,"Failed to build file ".concat(e,"."),reset),t.message}}function circularFile(e,t,r){var s=path.join(e,r),i=path.join(input,"i18n");fs.existsSync(s)&&s!==output&&s!==i&&fs.readdirSync(s).forEach(function(i){var n=path.join(s,i),a=fs.statSync(n);if(a.isFile()){var o=path.basename(n),c=path.extname(n),l=path.join(t,r,path.basename(i));if(l===path.join(output,"manifest.json"))return;FILE_EXT_NAME.indexOf(c)<0&&".DS_Store"!==o?toCopyFile(n,l,a):".json"===c&&(n.toString().startsWith(resourcesPath)||n.toString().startsWith(sharePath))&&toCopyFile(n,l,a)}else a.isDirectory()&&circularFile(e,t,path.join(r,i))})}function toCopyFile(e,t,r){if(fs.existsSync(t)){var s=fs.statSync(t);s.isFile()&&r.size!==s.size&&copyFile(e,t)}else copyFile(e,t)}var ResourcePlugin=function(){function e(t,r,s,i){(0,_classCallCheck2.default)(this,e),input=t,output=r,manifestFilePath=s,watchCSSFiles=i,shareThemePath=path.join(t,"../share/resources/styles"),internalThemePath=path.join(t,"resources/styles"),resourcesPath=path.join(t,"resources"),sharePath=path.resolve(t,"../share/resources")}return(0,_createClass2.default)(e,[{key:"apply",value:function(e){var t=this;e.hooks.beforeCompile.tap("resource Copy",function(){(0,_newArrowCheck2.default)(this,t),circularFile(input,output,""),circularFile(input,output,"../share")}.bind(this)),e.hooks.normalModuleFactory.tap("OtherEntryOptionPlugin",function(){(0,_newArrowCheck2.default)(this,t);var r=readCSSInfo(watchCSSFiles);if("card"!==process.env.DEVICE_LEVEL||"moduleJson"===process.env.compileMode){for(var s in addPageEntryObj(),entryObj=Object.assign(entryObj,abilityEntryObj),checkTestRunner(input,entryObj),entryObj){if(!e.options.entry[s])new SingleEntryPlugin("",entryObj[s],s).apply(e);setCSSEntry(r,s)}writeCSSInfo(watchCSSFiles,r)}else{for(var i in e.options.entry)setCSSEntry(r,i);writeCSSInfo(watchCSSFiles,r)}}.bind(this)),e.hooks.done.tap("copyManifest",function(){(0,_newArrowCheck2.default)(this,t),copyManifest(),fs.existsSync(path.join(output,"app.js"))&&fs.utimesSync(path.join(output,"app.js"),new Date,new Date)}.bind(this))}}]),e}();function copyManifest(){copyFile(manifestFilePath,path.join(output,"manifest.json"))}var entryObj={};function addPageEntryObj(){var e=this;if(entryObj={},"page"===process.env.abilityType){var t=readManifest(manifestFilePath).pages;if(void 0===t)throw Error("ERROR: missing pages").message;t.forEach(function(t){(0,_newArrowCheck2.default)(this,e);var r=t.replace(/^\.\/js\//,""),s=path.join(input,r+".hml"),i=process.env.aceSuperVisualPath||"",n=path.join(i,r+".visual"),a=fs.existsSync(s),o=fs.existsSync(n),c=process.env.projectPath;a&&o?console.error("ERROR: "+r+" cannot both have hml && visual"):a?entryObj["./"+r]=path.resolve(c,"./"+r+".hml?entry"):o&&(entryObj["./"+r]=path.resolve(i,"./"+r+".visual?entry"))}.bind(this))}return"true"!==process.env.isPreview&&"rich"===process.env.DEVICE_LEVEL&&loadWorker(entryObj),entryObj}var abilityEntryObj={};function addAbilityEntryObj(e){var t=this;return abilityEntryObj={},readAbilityEntrance(e).forEach(function(e){(0,_newArrowCheck2.default)(this,t);var r=e.replace(/^\.\/js\//,"./").replace(/\.js$/,"");abilityEntryObj[r]=path.resolve(process.env.projectPath,"../",e)}.bind(this)),abilityEntryObj}function readAbilityEntrance(e){var t=[];return e.module&&(e.module.srcEntrance&&t.push(e.module.srcEntrance),e.module.abilities&&e.module.abilities.length&&readEntrances(e.module.abilities,t),e.module.extensionAbilities&&e.module.extensionAbilities.length&&readEntrances(e.module.extensionAbilities,t)),t}function readEntrances(e,t){var r=this;e.forEach(function(e){(0,_newArrowCheck2.default)(this,r),e.type&&"form"===e.type||!e.srcEntrance||t.push(e.srcEntrance)}.bind(this))}function readManifest(e){var t={};try{if(fs.existsSync(e)){var r=fs.readFileSync(e).toString();t=JSON.parse(r)}else{if(!process.env.aceModuleJsonPath||!fs.existsSync(process.env.aceModuleJsonPath))throw Error("[31mERROR: the manifest.json or module.json is lost.[39m").message;buildManifest(t)}}catch(e){throw Error("[31mERROR: the manifest.json or module.json file format is invalid.[39m").message}return t}function readModulePages(e){if(("hml"===e.module.uiSyntax||"js"===e.module.uiSyntax)&&e.module.pages){var t=path.resolve(process.env.aceProfilePath,"".concat(e.module.pages.replace(/\$profile\:/,""),".json"));if(fs.existsSync(t))return JSON.parse(fs.readFileSync(t,"utf-8")).src}}function readFormPages(e){var t=this,r=[];return e.module.extensionAbilities&&e.module.extensionAbilities.length&&e.module.extensionAbilities.forEach(function(e){var s=this;(0,_newArrowCheck2.default)(this,t),e.type&&"form"===e.type&&e.metadata&&e.metadata.length&&e.metadata.forEach(function(e){(0,_newArrowCheck2.default)(this,s),e.resource&&/\$profile\:/.test(e.resource)&&parseFormConfig(e.resource,r)}.bind(this))}.bind(this)),r}function parseFormConfig(e,t){var r=this,s=path.resolve(process.env.aceProfilePath,"".concat(e.replace(/\$profile\:/,""),".json"));if(fs.existsSync(s)){var i=JSON.parse(fs.readFileSync(s,"utf-8"));i.forms&&i.forms.length&&i.forms.forEach(function(e){(0,_newArrowCheck2.default)(this,r),e.src&&t.push(e.src)}.bind(this))}}function buildManifest(e){try{var t=JSON.parse(fs.readFileSync(process.env.aceModuleJsonPath).toString());"rich"===process.env.DEVICE_LEVEL&&(e.pages=readModulePages(t),e.abilityEntryObj=addAbilityEntryObj(t)),"card"===process.env.DEVICE_LEVEL&&(e.pages=readFormPages(t)),e.minPlatformVersion=t.app.minAPIVersion}catch(e){throw Error("[31mERROR: the module.json file is lost or format is invalid.[39m").message}}function loadWorker(e){var t=this;if(validateWorkOption()){JSON.parse(fs.readFileSync(process.env.aceBuildJson).toString()).workers.forEach(function(r){(0,_newArrowCheck2.default)(this,t),/\.(js)$/.test(r)||(r+=".js");var s=path.relative(process.env.projectPath,r);filterWorker(s)&&(e[s.replace(/\.(ts|js)$/,"")]=r)}.bind(this))}else{var r=path.resolve(input,"workers");if(fs.existsSync(r)){var s=[];readFile(r,s),s.forEach(function(s){if((0,_newArrowCheck2.default)(this,t),/\.js$/.test(s)){var i=path.relative(r,s).replace(/\.js$/,"");e["./workers/"+i]=s}}.bind(this))}}}function validateWorkOption(){if(process.env.aceBuildJson&&fs.existsSync(process.env.aceBuildJson)&&JSON.parse(fs.readFileSync(process.env.aceBuildJson).toString()).workers)return!0;return!1}function filterWorker(e){return/\.(ts|js)$/.test(e)&&!/^\.\./.test(e)}function readFile(e,t){var r=this;try{fs.readdirSync(e).forEach(function(s){(0,_newArrowCheck2.default)(this,r);var i=path.join(e,s);fs.statSync(i).isDirectory()?readFile(i,t):t.push(i)}.bind(this))}catch(e){console.error(e.message)}}function themeFileBuild(e,t){if(fs.existsSync(e)){var r=JSON.parse(fs.readFileSync(e)),s={};if(r&&r.style){s.style={};var i=r.style;return Object.keys(i).forEach(function(e){var t=CUSTOM_THEME_PROP_GROUPS[e],r=OHOS_THEME_PROP_GROUPS[e];r?s.style[r]=i[e]:t?s.style[t]=i[e]:s.style[e]=i[e]}),fs.writeFileSync(t,JSON.stringify(s,null,2)),!0}}return!1}function readCSSInfo(e){return fs.existsSync(e)?JSON.parse(fs.readFileSync(e)):{}}function writeCSSInfo(e,t){fs.existsSync(path.resolve(e,".."))||(0,_util.mkDir)(path.resolve(e,"..")),fs.existsSync(e)&&fs.unlinkSync(e),fs.writeFileSync(e,JSON.stringify(t,null,2))}function setCSSEntry(e,t){e.entry=e.entry||{},fs.existsSync(path.join(input,t+".css"))&&(e.entry[path.join(input,t+".css")]=!0)}function checkTestRunner(e,t){var r=path.join(path.parse(e).dir,"TestRunner");if(fs.existsSync(r)&&fs.statSync(r).isDirectory()){walkSync(r,[],t,e)}}function walkSync(e,t,r,s){fs.readdirSync(e).forEach(function(i){var n=path.join(e,i),a=fs.statSync(n);if(a.isFile()){if(".js"===path.extname(n)){var o=n.replace(path.parse(s).dir,"").replace(".js","");r["../".concat(o)]=n}else a.isDirectory()&&walkSync(n,t,r,s)}})}module.exports=ResourcePlugin;