"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.appComponentCollection=void 0,exports.createLanguageService=createLanguageService,exports.importModuleCollection=exports.extendCollection=exports.dollarCollection=exports.decoratorParamsCollection=void 0;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),ts=_interopRequireWildcard(require("typescript")),_main=require("../main"),_validate_ui_syntax=require("./validate_ui_syntax"),_pre_define=require("./pre_define"),_component_map=require("./component_map"),_process_component_build=require("./process_component_build");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,s=new WeakMap;return(_getRequireWildcardCache=function(e){return e?s:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var s,r,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&((r=o?Object.getOwnPropertyDescriptor(e,s):null)&&(r.get||r.set)?Object.defineProperty(n,s,r):n[s]=e[s]);return n.default=e,t&&t.set(e,n),n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function readDeaclareFiles(){var t=this;const s=[];return _fs.default.readdirSync(_path.default.resolve(__dirname,"../declarations")).forEach(function(e){_newArrowCheck(this,t),/\.d\.ts$/.test(e)&&s.push(_path.default.resolve(__dirname,"../declarations",e))}.bind(this)),s}function createLanguageService(e){var t=this;const a=ts.readConfigFile(_path.default.resolve(__dirname,"../tsconfig.json"),ts.sys.readFile).config.compilerOptions;Object.assign(a,{allowJs:!1,importsNotUsedAsValues:ts.ImportsNotUsedAsValues.Preserve,module:ts.ModuleKind.CommonJS,moduleResolution:ts.ModuleResolutionKind.NodeJs,target:ts.ScriptTarget.ES2017,baseUrl:_path.default.resolve(_main.projectConfig.projectPath),paths:{"*":["*","../../../../../*"]},lib:["lib.es2020.d.ts"]});const s={};var r={getScriptFileNames:function(){return _newArrowCheck(this,t),[...e,...readDeaclareFiles()]}.bind(this),getScriptVersion:function(e){return _newArrowCheck(this,t),s[e]&&s[e].version.toString()}.bind(this),getScriptSnapshot:function(e){if(_newArrowCheck(this,t),_fs.default.existsSync(e))return/(?<!\.d)\.(ets|ts)$/.test(e)?(checkUISyntax(_fs.default.readFileSync(e).toString(),e),ts.ScriptSnapshot.fromString(processContent(_fs.default.readFileSync(e).toString()))):ts.ScriptSnapshot.fromString(_fs.default.readFileSync(e).toString())}.bind(this),getCurrentDirectory:function(){return _newArrowCheck(this,t),process.cwd()}.bind(this),getCompilationSettings:function(){return _newArrowCheck(this,t),a}.bind(this),getDefaultLibFileName:function(e){return _newArrowCheck(this,t),ts.getDefaultLibFilePath(e)}.bind(this),fileExists:ts.sys.fileExists,readFile:ts.sys.readFile,readDirectory:ts.sys.readDirectory,resolveModuleNames(e,t){const s=[];for(const i of e){var r,n,o=ts.resolveModuleName(i,t,a,{fileExists(e){return ts.sys.fileExists(e)},readFile(e){return ts.sys.readFile(e)}});o.resolvedModule?s.push(o.resolvedModule):/^@(system|ohos)/.test(i.trim())?(r=_path.default.resolve(__dirname,"../../../api",i+".d.ts"),ts.sys.fileExists(r)?s.push(getResolveModule(r,".d.ts")):s.push(null)):/\.ets$/.test(i)?(r=_path.default.resolve(_path.default.dirname(t),i),ts.sys.fileExists(r)?s.push(getResolveModule(r,".ets")):s.push(null)):/\.ts$/.test(i)?(n=_path.default.resolve(_path.default.dirname(t),i),ts.sys.fileExists(n)?s.push(getResolveModule(n,".ts")):s.push(null)):(n=_path.default.resolve(__dirname,"../../../api",i+".d.ts"),ts.sys.fileExists(n)?s.push(getResolveModule(n,".d.ts")):s.push(null))}return s},directoryExists:ts.sys.directoryExists,getDirectories:ts.sys.getDirectories};return ts.createLanguageService(r,ts.createDocumentRegistry())}function getResolveModule(e,t){return{resolvedFileName:e,isExternalLibraryImport:!1,extension:t}}const dollarCollection=new Set;exports.dollarCollection=dollarCollection;const appComponentCollection=new Set;exports.appComponentCollection=appComponentCollection;const decoratorParamsCollection=new Set;exports.decoratorParamsCollection=decoratorParamsCollection;const extendCollection=new Set;exports.extendCollection=extendCollection;const importModuleCollection=new Set;function checkUISyntax(e,t){/\.ets$/.test(t)&&"app.ets"!==_path.default.basename(t)&&(collectComponents(e=ts.createSourceFile(t,e,ts.ScriptTarget.Latest,!0,ts.ScriptKind.ETS)),parseAllNode(e,e))}function collectComponents(e){if(e.identifiers&&e.identifiers.size)for(const t of e.identifiers.keys())_component_map.JS_BIND_COMPONENTS.has(t)&&appComponentCollection.add(t)}function parseAllNode(e,t){var n=this;if(ts.isStructDeclaration(e)&&e.members&&e.members.forEach(function(t){if(_newArrowCheck(this,n),ts.isPropertyDeclaration(t)&&ts.isIdentifier(t.name)){var s=t.name.getText();if(t.decorators&&t.decorators.length)for(let e=0;e<t.decorators.length;e++){var r=t.decorators[e].getText().replace(/\(.*\)$/,"").trim();_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(r)&&dollarCollection.add("$"+s),isDecoratorCollection(t.decorators[e],r)&&decoratorParamsCollection.add(t.decorators[e].expression.arguments[0].getText())}}}.bind(this)),ts.isIfStatement(e)&&appComponentCollection.add(_pre_define.COMPONENT_IF),ts.isMethodDeclaration(e)&&e.name.getText()===_pre_define.COMPONENT_BUILD_FUNCTION&&e.body&&e.body.statements&&e.body.statements.length){const s=e.body.statements;s.forEach(function(e,t){_newArrowCheck(this,n),traverseBuild(e,t)}.bind(this))}e.getChildren().forEach(function(e){return _newArrowCheck(this,n),parseAllNode(e,t)}.bind(this))}function traverseBuild(t,s){var r=this;if(ts.isExpressionStatement(t)){let e=(0,_process_component_build.getName)(t);if(!_component_map.INNER_COMPONENT_NAMES.has(e)&&t.parent&&t.parent.statements&&1<=s&&t.parent.statements[s-1].expression&&t.parent.statements[s-1].expression.expression&&(e=t.parent.statements[s-1].expression.expression.escapedText),(t=t.expression)&&t.body&&ts.isBlock(t.body))t.body.statements.forEach(function(e,t){_newArrowCheck(this,r),traverseBuild(e,t)}.bind(this));else for(;t;){if(ts.isCallExpression(t)&&ts.isPropertyAccessExpression(t.expression)){const o=t.arguments;var n=t.expression.name;(n.escapedText===_pre_define.BIND_POPUP||n.escapedText===_pre_define.CHECKED&&e===_pre_define.RADIO)&&o.forEach(function(e){if(_newArrowCheck(this,r),e.getText().startsWith(_pre_define.$$)){for(;e.expression;)e=e.expression;dollarCollection.add(e.getText())}}.bind(this))}t=t.expression}}else ts.isIfStatement(t)&&(t.thenStatement&&ts.isBlock(t.thenStatement)&&t.thenStatement.statements&&t.thenStatement.statements.forEach(function(e,t){_newArrowCheck(this,r),traverseBuild(e,t)}.bind(this)),t.elseStatement&&ts.isBlock(t.elseStatement)&&t.elseStatement.statements&&t.elseStatement.statements.forEach(function(e,t){_newArrowCheck(this,r),traverseBuild(e,t)}.bind(this)))}function isDecoratorCollection(e,t){return _pre_define.COMPONENT_DECORATORS_PARAMS.has(t)&&e.expression.arguments&&e.expression.arguments.length&&ts.isIdentifier(e.expression.arguments[0])}function processDraw(e){var s=this;return e.replace(/new\s+\b(Circle|Ellipse|Rect|Path)\b/g,function(e,t){return _newArrowCheck(this,s),"Â ".repeat(e.length-t.length)+t}.bind(this))}function processContent(e){return e=(0,_validate_ui_syntax.processSystemApi)(e),e=processDraw(e=(0,_validate_ui_syntax.preprocessExtend)(e,extendCollection))}exports.importModuleCollection=importModuleCollection;