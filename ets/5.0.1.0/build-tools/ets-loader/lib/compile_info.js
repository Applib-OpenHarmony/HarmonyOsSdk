"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.props=exports.logger=exports.ResultStates=void 0;var ts=_interopRequireWildcard(require("typescript")),_Compilation=_interopRequireDefault(require("webpack/lib/Compilation")),_JavascriptModulesPlugin=_interopRequireDefault(require("webpack/lib/javascript/JavascriptModulesPlugin")),_log4js=require("log4js"),_RawSource=_interopRequireDefault(require("webpack-sources/lib/RawSource")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_CachedSource=_interopRequireDefault(require("webpack-sources/lib/CachedSource")),_ConcatSource=_interopRequireDefault(require("webpack-sources/lib/ConcatSource")),_process_ui_syntax=require("./process_ui_syntax"),_validate_ui_syntax=require("./validate_ui_syntax"),_main=require("../main"),_utils=require("./utils"),_pre_define=require("./pre_define"),_ets_checker=require("./ets_checker");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,o,i={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((o=n?Object.getOwnPropertyDescriptor(e,r):null)&&(o.get||o.set)?Object.defineProperty(i,r,o):i[r]=e[r]);return i.default=e,t&&t.set(e,i),i}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}(0,_log4js.configure)({appenders:{ETS:{type:"stderr",layout:{type:"messagePassThrough"}}},categories:{default:{appenders:["ETS"],level:"info"}}});const logger=(0,_log4js.getLogger)("ETS");exports.logger=logger;const props=[];exports.props=props;const GLOBAL_COMMON_MODULE_CACHE=`
globalThis["__common_module_cache__"] = globalThis["__common_module_cache__"] || {};
globalThis["webpackChunkcompilier"].forEach((item)=> {
  Object.keys(item[1]).forEach((element) => {
    globalThis["__common_module_cache__"][element] = null;
  })
});`;class ResultStates{constructor(){_defineProperty(this,"mStats",void 0),_defineProperty(this,"mErrorCount",0),_defineProperty(this,"mWarningCount",0),_defineProperty(this,"warningCount",0),_defineProperty(this,"noteCount",0),_defineProperty(this,"red","[31m"),_defineProperty(this,"yellow","[33m"),_defineProperty(this,"blue","[34m"),_defineProperty(this,"reset","[39m"),_defineProperty(this,"modulePaths",new Set([]))}apply(e){var n=this;e.hooks.compilation.tap("SourcemapFixer",function(e){var o=this;_newArrowCheck(this,n),e.hooks.afterProcessAssets.tap("SourcemapFixer",function(t){var r=this;_newArrowCheck(this,o),Reflect.ownKeys(t).forEach(function(e){_newArrowCheck(this,r),/\.map$/.test(e.toString())&&t[e]._value&&(t[e]._value=t[e]._value.toString().replace(".ets?entry",".ets"),t[e]._value=t[e]._value.toString().replace(".ts?entry",".ts"))}.bind(this))}.bind(this)),e.hooks.buildModule.tap("findModule",function(e){_newArrowCheck(this,o),/node_modules/.test(e.context)&&(e=_path.default.resolve(e.resourceResolveData.descriptionFileRoot,_pre_define.MODULE_SHARE_PATH),_fs.default.existsSync(e)&&this.modulePaths.add(e))}.bind(this))}.bind(this)),e.hooks.afterCompile.tap("copyFindModule",function(){var t=this;_newArrowCheck(this,n),this.modulePaths.forEach(function(e){_newArrowCheck(this,t),(0,_utils.circularFile)(e,_path.default.resolve(_main.projectConfig.buildPath,_pre_define.BUILD_SHARE_PATH))}.bind(this))}.bind(this)),e.hooks.compilation.tap("CommonAsset",function(e){var t=this;_newArrowCheck(this,n),e.hooks.processAssets.tap({name:"GLOBAL_COMMON_MODULE_CACHE",stage:_Compilation.default.PROCESS_ASSETS_STAGE_ADDITIONS},function(e){_newArrowCheck(this,t),e["commons.js"]?e["commons.js"]=new _CachedSource.default(new _ConcatSource.default(e["commons.js"],GLOBAL_COMMON_MODULE_CACHE)):e["vendors.js"]&&(e["vendors.js"]=new _CachedSource.default(new _ConcatSource.default(e["vendors.js"],GLOBAL_COMMON_MODULE_CACHE)))}.bind(this))}.bind(this)),e.hooks.compilation.tap("Require",function(e){var t=this;_newArrowCheck(this,n),_JavascriptModulesPlugin.default.getCompilationHooks(e).renderRequire.tap("renderRequire",function(e){return _newArrowCheck(this,t),'var commonCachedModule = globalThis["__common_module_cache__"] ? globalThis["__common_module_cache__"][moduleId]: null;\nif (commonCachedModule) { return commonCachedModule.exports; }\n'+e.replace("// Execute the module function",'if (globalThis["__common_module_cache__"] && moduleId.indexOf("?name=") < 0 && Object.keys(globalThis["__common_module_cache__"]).indexOf(moduleId) >= 0) {\n  globalThis["__common_module_cache__"][moduleId] = module;\n}')}.bind(this))}.bind(this)),e.hooks.entryOption.tap("beforeRun",function(){var i=this;_newArrowCheck(this,n);const t=[];Object.values(_main.projectConfig.entryObj).forEach(function(e){_newArrowCheck(this,i),t.push(e.replace("?entry",""))}.bind(this));const e=(0,_ets_checker.createLanguageService)(t);_main.globalProgram.program=e.getProgram();const r=_main.globalProgram.program;props.push(..._ets_checker.dollarCollection,..._ets_checker.decoratorParamsCollection,..._ets_checker.extendCollection);let o=r.getSyntacticDiagnostics().concat(r.getSemanticDiagnostics()).concat(r.getDeclarationDiagnostics());o=o.filter(function(e){return _newArrowCheck(this,i),this.validateError(ts.flattenDiagnosticMessageText(e.messageText,"\n"))}.bind(this)),this.mErrorCount+=o.length,o.forEach(function(e){_newArrowCheck(this,i);var t,r,o=ts.flattenDiagnosticMessageText(e.messageText,"\n");e.file?({line:t,character:r}=e.file.getLineAndCharacterOfPosition(e.start),logger.error(this.red,`ETS:ERROR File: ${e.file.fileName}:${t+1}:${r+1}
 ${o}
`)):logger.error(this.red,"ETS:ERROR: "+o)}.bind(this))}.bind(this)),e.hooks.done.tap("Result States",function(e){_newArrowCheck(this,n),_main.projectConfig.isPreview&&_main.projectConfig.aceSoPath&&_validate_ui_syntax.useOSFiles&&0<_validate_ui_syntax.useOSFiles.size&&this.writeUseOSFiles(),this.mStats=e,this.warningCount=0,this.noteCount=0,this.mStats.compilation.errors&&(this.mErrorCount+=this.mStats.compilation.errors.length),this.mStats.compilation.warnings&&(this.mWarningCount=this.mStats.compilation.warnings.length),this.printResult()}.bind(this)),_main.projectConfig.isPreview||e.hooks.compilation.tap("Collect Components And Modules",function(t){var r=this;_newArrowCheck(this,n),t.hooks.additionalAssets.tapAsync("Collect Components And Modules",function(e){_newArrowCheck(this,r),_main.projectConfig.aceSuperVisualPath&&_fs.default.existsSync(_main.projectConfig.aceSuperVisualPath)&&_ets_checker.appComponentCollection.clear(),t.assets["./component_collection.txt"]=new _RawSource.default(Array.from(_ets_checker.appComponentCollection).join(",")),t.assets["./module_collection.txt"]=new _RawSource.default(0===_validate_ui_syntax.moduleCollection.size?"NULL":Array.from(_validate_ui_syntax.moduleCollection).join(",")),e()}.bind(this))}.bind(this))}writeUseOSFiles(){let e="";var t;_fs.default.existsSync(_main.projectConfig.aceSoPath)?e=_fs.default.readFileSync(_main.projectConfig.aceSoPath,"utf-8")+"\n":(t=_path.default.join(_main.projectConfig.aceSoPath,".."),_fs.default.existsSync(t)&&!_fs.default.statSync(t).isFile()||(0,_utils.mkDir)(t)),_fs.default.writeFileSync(_main.projectConfig.aceSoPath,e+Array.from(_validate_ui_syntax.useOSFiles).join("\n"))}printResult(){if(this.printWarning(),this.printError(),0<this.mErrorCount+this.warningCount+this.noteCount){let e,t="";0<this.mErrorCount?(t+="ERROR:"+this.mErrorCount,e="FAIL ",/ets_loader_ark$/.test(_path.default.resolve(__dirname,".."))||(process.exitCode=1)):e="SUCCESS ",0<this.warningCount&&(t+=" WARN:"+this.warningCount),0<this.noteCount&&(t+=" NOTE:"+this.noteCount),logger.info(this.blue,"COMPILE RESULT:"+e+`{${t}}`,this.reset)}else console.info(this.blue,"COMPILE RESULT:SUCCESS ",this.reset);this.clearCount()}clearCount(){this.mErrorCount=0,this.warningCount=0,this.noteCount=0}printWarning(){if(0<this.mWarningCount){const r=this.mStats.compilation.warnings;var t=r.length;for(let e=0;e<t;e++){const o=r[e].message.replace(/^Module Warning\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"");/^NOTE/.test(o)?(this.noteCount++,logger.info(this.blue,o,this.reset,"\n")):(this.warningCount++,logger.warn(this.yellow,o.replace(/^WARN/,"ETS:WARN"),this.reset,"\n"))}this.mWarningCount>t&&(this.warningCount=this.warningCount+this.mWarningCount-t)}}printError(){if(0<this.mErrorCount){const i=[...this.mStats.compilation.errors];for(let e=0;e<i.length;e++){var t,r,o;i[e].issue?(r=i[e].issue.location?`:${i[e].issue.location.start.line}:`+i[e].issue.location.start.column:"",t=i[e].issue.file+r,r=i[e].issue.message,logger.error(this.red,"ETS:ERROR File: "+t,this.reset),logger.error(this.red,r,this.reset,"\n")):/BUILDERROR/.test(i[e].message)?(o=i[e].message.replace(/^Module Error\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"").replace(/^ERROR/,"ETS:ERROR"),this.printErrorMessage(o,!0,i[e])):(o=i[e].message.replace(/\[tsl\]\s*/,"").replace(/\u001b\[.*?m/g,"").replace(/\.ets\.ts/g,".ets").trim()+`
`,o=this.filterModuleError(o).replace(/^ERROR in /,"ETS:ERROR File: ").replace(/\s{6}TS/g," TS").replace(/\(([0-9]+),([0-9]+)\)/,":$1:$2"),this.printErrorMessage(o,!1,i[e]))}}}printErrorMessage(e,t,r){this.validateError(e)?t?logger.error(this.red,e+"\n",this.reset):logger.error(this.red,e,this.reset):(r=this.mStats.compilation.errors.indexOf(r),this.mStats.compilation.errors.splice(r,1),this.mErrorCount=this.mErrorCount-1)}validateError(e){return!(this.matchMessage(e,props,/Cannot find name\s*'(\$?\$?[_a-zA-Z0-9]+)'/)||this.matchMessage(e,props,/Property\s*'(\$?[_a-zA-Z0-9]+)' does not exist on type/)||this.matchMessage(e,[..._ets_checker.importModuleCollection],/Cannot find namespace\s*'([_a-zA-Z0-9]+)'\./))}matchMessage(t,e,r){var o=this;if(_ets_checker.importModuleCollection.forEach(function(e){if(_newArrowCheck(this,o),t.includes(e))return!0}.bind(this)),r.test(t)){r=t.match(r);if(r[1]&&e.includes(r[1]))return!0}return!1}filterModuleError(e){var t,r;return/You may need an additional loader/.test(e)&&_process_ui_syntax.transformLog&&_process_ui_syntax.transformLog.sourceFile&&(t=_process_ui_syntax.transformLog.sourceFile.fileName,(r=e.split("You may need an additional loader to handle the result of these loaders."))&&1<r.length&&r[1]&&(e=`ERROR in ${t}
 The following syntax is incorrect.`+r[1])),e}}exports.ResultStates=ResultStates;