"use strict";var childProcess=_interopRequireWildcard(require("child_process")),process=_interopRequireWildcard(require("process")),fs=_interopRequireWildcard(require("fs")),_cluster=_interopRequireDefault(require("cluster")),_compile_info=require("./compile_info");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};r=_getRequireWildcardCache(r);if(r&&r.has(e))return r.get(e);var t,i,o={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((i=c?Object.getOwnPropertyDescriptor(e,t):null)&&(i.get||i.set)?Object.defineProperty(o,t,i):o[t]=e[t]);return o.default=e,r&&r.set(e,o),o}const red="[31m",reset="[39m";function js2abcByWorkers(e,r){var t=JSON.parse(e);for(let e=0;e<t.length;++e){const o=t[e].path;var i=`${r} "${o}"`;_compile_info.logger.debug("gen abc cmd is: ",i," ,file size is:",t[e].size," byte");try{childProcess.execSync(i)}catch(e){return void _compile_info.logger.error(red,`ETS:ERROR Failed to convert file ${o} to abc `,reset)}const c=o.replace(/\.js$/,".abc");fs.existsSync(c)?(i=c.replace(/_.abc$/,".abc"),fs.renameSync(c,i)):_compile_info.logger.error(red,`ETS:ERROR ${c} is lost`,reset)}}_compile_info.logger.debug("worker data is: ",JSON.stringify(process.env)),_compile_info.logger.debug("gen_abc isWorker is: ",_cluster.default.isWorker),_cluster.default.isWorker&&void 0!==process.env.inputs&&void 0!==process.env.cmd&&(_compile_info.logger.debug("==>worker #",_cluster.default.worker.id,"started!"),js2abcByWorkers(process.env.inputs,process.env.cmd),process.exit());