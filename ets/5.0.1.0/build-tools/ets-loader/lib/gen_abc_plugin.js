"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenAbcPlugin=void 0;var fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),_cluster=_interopRequireDefault(require("cluster")),_process=_interopRequireDefault(require("process")),_compile_info=require("./compile_info"),_utils=require("./utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,i,s={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((i=n?Object.getOwnPropertyDescriptor(e,r):null)&&(i.get||i.set)?Object.defineProperty(s,r,i):s[r]=e[r]);return s.default=e,t&&t.set(e,s),s}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const firstFileEXT="_.js",genAbcScript="gen_abc.js";let output,isWin=!1,isMac=!1,isDebug=!1,arkDir,nodeJs;const intermediateJsBundle=[];let fileterIntermediateJsBundle=[],hashJsonObject={},buildPathInfo="";const red="[31m",reset="[39m",hashFile="gen_hash.json",ARK="/ark/";class GenAbcPlugin{constructor(e,t,r,i){output=e,arkDir=t,nodeJs=r,isDebug=i}apply(e){var t=this;if(fs.existsSync(path.resolve(arkDir,"build-win")))isWin=!0;else if(fs.existsSync(path.resolve(arkDir,"build-mac")))isMac=!0;else if(!fs.existsSync(path.resolve(arkDir,"build")))return void _compile_info.logger.error(red,"ETS:ERROR find build fail",reset);e.hooks.emit.tap("GenAbcPlugin",function(i){var s=this;_newArrowCheck(this,t),Object.keys(i.assets).forEach(function(e){var t,r;_newArrowCheck(this,s),output&&".js"===path.extname(e)&&(t=i.assets[e].source(),r=e.replace(/\.js$/,firstFileEXT),writeFileSync(t,path.resolve(output,r),e))}.bind(this))}.bind(this)),e.hooks.afterEmit.tap("GenAbcPluginMultiThread",function(){_newArrowCheck(this,t),buildPathInfo=output,invokeWorkersToGenAbc()}.bind(this))}}function writeFileSync(e,t,r){var i=path.join(t,"..");fs.existsSync(i)&&fs.statSync(i).isDirectory()||mkDir(i),fs.writeFileSync(t,e),fs.existsSync(t)?(e=fs.statSync(t).size,intermediateJsBundle.push({path:t,size:e})):_compile_info.logger.error(red,`ETS:ERROR Failed to convert file ${r} to bin. ${t} is lost`,reset)}function mkDir(e){var t=path.join(e,"..");fs.existsSync(t)&&!fs.statSync(t).isFile()||mkDir(t),fs.mkdirSync(e)}function getSmallestSizeGroup(e){const t=Array.from(e);return t.sort(function(e,t){return e[1]-t[1]}),t[0][0]}function splitJsBundlesBySize(e,t){const r=[];if(e.length<t)return r.push(e),r;e.sort(function(e,t){return t.size-e.size});const i=new Map;for(let e=0;e<t;++e)r.push([]),i.set(e,0);let s=0;for(;s<e.length;){var n=getSmallestSizeGroup(i);r[n].push(e[s]);var o=i.get(n)+e[s].size;i.set(n,o),s++}return r}function invokeWorkersToGenAbc(){var i=this;let e="";isDebug&&(e+=" --debug");let t=path.join(arkDir,"build","src","index.js");isWin?t=path.join(arkDir,"build-win","src","index.js"):isMac&&(t=path.join(arkDir,"build-mac","src","index.js")),filterIntermediateJsBundleByHashJson(buildPathInfo,intermediateJsBundle);var r=splitJsBundlesBySize(fileterIntermediateJsBundle,3),s=3<r.length?3:r.length,n=`${nodeJs} --expose-gc "${t}" ${e} `,o=16<=parseInt(_process.default.version.split(".")[0]);if(o&&_cluster.default.isPrimary||!o&&_cluster.default.isMaster){o?_cluster.default.setupPrimary({exec:path.resolve(__dirname,genAbcScript)}):_cluster.default.setupMaster({exec:path.resolve(__dirname,genAbcScript)});for(let e=0;e<s;++e){var a={inputs:JSON.stringify(r[e]),cmd:n};_cluster.default.fork(a)}_cluster.default.on("exit",function(e,t,r){_newArrowCheck(this,i),_compile_info.logger.debug(`worker ${e.process.pid} finished`)}.bind(this)),_process.default.on("exit",function(e){_newArrowCheck(this,i),writeHashJson()}.bind(this))}}function filterIntermediateJsBundleByHashJson(e,t){for(let e=0;e<t.length;++e)fileterIntermediateJsBundle.push(t[e]);e=genHashJsonPath(e);if(0!==e.length){const o={};var r;if(fs.existsSync(e)){e=fs.readFileSync(e).toString(),r=JSON.parse(e),fileterIntermediateJsBundle=[];for(let e=0;e<t.length;++e){const a=t[e].path;var i,s,n=a.replace(/_.js$/,".abc");fs.existsSync(a)?fs.existsSync(n)?(i=(0,_utils.toHashData)(a),s=(0,_utils.toHashData)(n),r[a]===i&&r[n]===s?(o[a]=i,o[n]=s,fs.unlinkSync(a)):fileterIntermediateJsBundle.push(t[e])):fileterIntermediateJsBundle.push(t[e]):_compile_info.logger.error(red,`ETS:ERROR ${a} is lost`,reset)}}hashJsonObject=o}}function writeHashJson(){for(let e=0;e<fileterIntermediateJsBundle.length;++e){const s=fileterIntermediateJsBundle[e].path;var t,r,i=s.replace(/_.js$/,".abc");fs.existsSync(s)&&fs.existsSync(i)?(t=(0,_utils.toHashData)(s),r=(0,_utils.toHashData)(i),hashJsonObject[s]=t,hashJsonObject[i]=r,fs.unlinkSync(s)):_compile_info.logger.error(red,`ETS:ERROR ${s} is lost`,reset)}var e=genHashJsonPath(buildPathInfo);0!==e.length&&fs.writeFileSync(e,JSON.stringify(hashJsonObject))}function genHashJsonPath(e){if(e=(0,_utils.toUnixPath)(e),_process.default.env.cachePath)return fs.existsSync(_process.default.env.cachePath)&&fs.statSync(_process.default.env.cachePath).isDirectory()?path.join(_process.default.env.cachePath,hashFile):(_compile_info.logger.error(red,"ETS:ERROR hash path does not exist",reset),"");if(0<=e.indexOf(ARK)){e=e.split(ARK),e=path.join(e[0],ARK);return fs.existsSync(e)&&fs.statSync(e).isDirectory()?path.join(e,hashFile):(_compile_info.logger.error(red,"ETS:ERROR hash path does not exist",reset),"")}return _compile_info.logger.debug(red,"ETS:ERROR not cache exist",reset),""}exports.GenAbcPlugin=GenAbcPlugin;