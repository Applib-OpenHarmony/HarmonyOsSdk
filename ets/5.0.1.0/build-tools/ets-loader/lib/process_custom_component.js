"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processCustomComponent=processCustomComponent;var _typescript=_interopRequireDefault(require("typescript")),_pre_define=require("./pre_define"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_member=require("./process_component_member"),_utils=require("./utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const localArray=[..._process_component_member.observedPropertyDecorators,_pre_define.COMPONENT_NON_DECORATOR,_pre_define.COMPONENT_PROP_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR],decoractorMap=new Map([[_pre_define.COMPONENT_STATE_DECORATOR,_validate_ui_syntax.stateCollection],[_pre_define.COMPONENT_LINK_DECORATOR,_validate_ui_syntax.linkCollection],[_pre_define.COMPONENT_PROP_DECORATOR,_validate_ui_syntax.propCollection],[_pre_define.COMPONENT_NON_DECORATOR,_validate_ui_syntax.regularCollection],[_pre_define.COMPONENT_PROVIDE_DECORATOR,_validate_ui_syntax.provideCollection],[_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_validate_ui_syntax.objectLinkCollection]]);function processCustomComponent(a,t,n){var o,s=this;if(_typescript.default.isCallExpression(a.expression)){let r=!1,e=(0,_process_component_member.createCustomComponentNewExpression)(a.expression),i;isHasChild(a.expression)&&(i=a.expression.arguments[0].properties.slice(),i.forEach(function(e,t){_newArrowCheck(this,s),isToChange(e,a.expression)&&(r=!0,e=_typescript.default.factory.updatePropertyAssignment(e,e.name,changeNodeFromCallToArrow(e.initializer)),i.splice(t,1,e))}.bind(this)),r&&(o=_typescript.default.factory.updateExpressionStatement(a,_typescript.default.factory.createNewExpression(a.expression.expression,a.expression.typeArguments,[_typescript.default.factory.createObjectLiteralExpression(i,!0)])),e=(0,_process_component_member.createCustomComponentNewExpression)(o.expression))),addCustomComponent(a,t,e,n)}}function isHasChild(e){return e.arguments&&e.arguments[0]&&_typescript.default.isObjectLiteralExpression(e.arguments[0])&&e.arguments[0].properties&&e.arguments[0].properties.length}function isToChange(e,t){const r=_process_component_member.builderParamObjectCollection.get(t.expression.getText());return e.initializer&&_typescript.default.isCallExpression(e.initializer)&&r&&r.has(e.name.getText())}function changeNodeFromCallToArrow(e){return _typescript.default.factory.createArrowFunction(void 0,void 0,[],void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(e)],!0))}function addCustomComponent(e,t,r,i){var a,n;_typescript.default.isNewExpression(r)&&(validateCustomComponentPrams(e,a=getCustomComponentName(r),n=[],i),addCustomComponentStatements(e,t,r,a,n))}function addCustomComponentStatements(e,t,r,i,a){var n=_utils.componentInfo.id.toString();t.push(createFindChildById(n,i),createCustomComponentIfStatement(n,_typescript.default.factory.updateExpressionStatement(e,(0,_process_component_member.createViewCreate)(r)),_typescript.default.factory.createObjectLiteralExpression(a,!0),i))}function validateCustomComponentPrams(t,r,i,a){var n=this;const o=new Set([]);var e=t.expression.arguments;const s=getCollectionSet(r,_validate_ui_syntax.propertyCollection),p=getCollectionSet(r,_validate_ui_syntax.linkCollection);if(e&&1===e.length&&_typescript.default.isObjectLiteralExpression(e[0])){const c=e[0];c.properties.forEach(function(e){_newArrowCheck(this,n),e.name&&_typescript.default.isIdentifier(e.name)&&o.add(e.name.escapedText.toString()),isThisProperty(e,s)?(validateStateManagement(e,r,a),isNonThisProperty(e,p)&&(isToChange(e,t.expression)&&(e=_typescript.default.factory.updatePropertyAssignment(e,e.name,changeNodeFromCallToArrow(e.initializer))),i.push(e))):validateNonExistentProperty(e,r,a)}.bind(this))}validateMandatoryToAssignmentViaParam(t,r,o,a),validateMandatoryToInitViaParam(t,r,o,a)}function getCustomComponentName(e){let t;return _typescript.default.isIdentifier(e.expression)?t=e.expression.escapedText.toString():_typescript.default.isPropertyAccessExpression(e.expression)&&(t=e.expression.name.escapedText.toString()),t}function getCollectionSet(e,t){return t&&t.get(e)||new Set([])}function isThisProperty(e,t){return!!(_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.name)&&t.has(e.name.escapedText.toString()))}function isNonThisProperty(e,t){return!(!_typescript.default.isPropertyAssignment(e)||!_typescript.default.isIdentifier(e.name)||t.has(e.name.escapedText.toString()))}function validateStateManagement(e,t,r){validateForbiddenToInitViaParam(e,t,r),checkFromParentToChild(e,t,r)}function checkFromParentToChild(e,t,r){let i;e.name&&e.name.escapedText&&(i=e.name.escapedText.toString());var a,n=getPropertyDecoratorKind(i,t);n&&(isInitFromParent(e)?!(a=getParentPropertyName(e,n,r))||(t=_process_component_member.curPropMap.get(a))&&!isCorrectInitFormParent(t,n)&&validateIllegalInitFromParent(e,i,n,a,t,r):isInitFromLocal(e)&&_typescript.default.isPropertyAssignment(e)&&(localArray.includes(n)||validateIllegalInitFromParent(e,i,n,e.initializer.getText(),_pre_define.COMPONENT_NON_DECORATOR,r)))}function isInitFromParent(e){if(_typescript.default.isPropertyAssignment(e)&&e.initializer)return!!(_typescript.default.isPropertyAccessExpression(e.initializer)&&e.initializer.expression&&e.initializer.expression.kind===_typescript.default.SyntaxKind.ThisKeyword&&_typescript.default.isIdentifier(e.initializer.name))||(!(!_typescript.default.isIdentifier(e.initializer)||!matchStartWithDollar(e.initializer.getText()))||void 0)}function isInitFromLocal(e){if(_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.initializer)&&!matchStartWithDollar(e.initializer.getText()))return!0}function getParentPropertyName(e,t,r){let i;var a=e.initializer;if(t===_pre_define.COMPONENT_LINK_DECORATOR)if(hasDollar(a)){const n=a.name||a;i=n.getText().replace(/^\$/,"")}else validateLinkWithoutDollar(e,r);else hasDollar(a)?validateNonLinkWithDollar(e,r):i=e.initializer.name.getText();return i}function isCorrectInitFormParent(e,t){switch(t){case _pre_define.COMPONENT_STATE_DECORATOR:case _pre_define.COMPONENT_PROVIDE_DECORATOR:if(e===_pre_define.COMPONENT_NON_DECORATOR)return!0;break;case _pre_define.COMPONENT_LINK_DECORATOR:if([_pre_define.COMPONENT_STATE_DECORATOR,_pre_define.COMPONENT_LINK_DECORATOR,_pre_define.COMPONENT_STORAGE_LINK_DECORATOR].includes(e))return!0;break;case _pre_define.COMPONENT_PROP_DECORATOR:if([_pre_define.COMPONENT_STATE_DECORATOR,..._process_component_member.propAndLinkDecorators].includes(e))return!0;break;case _pre_define.COMPONENT_NON_DECORATOR:if([_pre_define.COMPONENT_STATE_DECORATOR,..._process_component_member.propAndLinkDecorators,_pre_define.COMPONENT_NON_DECORATOR,_pre_define.COMPONENT_OBJECT_LINK_DECORATOR,_pre_define.COMPONENT_STORAGE_LINK_DECORATOR].includes(e))return!0;break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:if(e===_pre_define.COMPONENT_STATE_DECORATOR)return!0}return!1}function getPropertyDecoratorKind(e,t){for(const r of decoractorMap.entries())if(getCollectionSet(t,r[1]).has(e))return r[0]}function createFindChildById(e,t){return _typescript.default.factory.createVariableStatement(void 0,_typescript.default.factory.createVariableDeclarationList([_typescript.default.factory.createVariableDeclaration(_typescript.default.factory.createIdentifier(""+_pre_define.CUSTOM_COMPONENT_EARLIER_CREATE_CHILD+e),void 0,_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(t)),_typescript.default.factory.createAsExpression(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(""+_pre_define.CUSTOM_COMPONENT_FUNCTION_FIND_CHILD_BY_ID)),void 0,[_typescript.default.factory.createStringLiteral(e)]),_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(t))))],_typescript.default.NodeFlags.Let))}function createCustomComponentIfStatement(e,t,r,i){e=""+_pre_define.CUSTOM_COMPONENT_EARLIER_CREATE_CHILD+e;return _typescript.default.factory.createIfStatement(_typescript.default.factory.createBinaryExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsEqualsToken),_typescript.default.factory.createIdentifier(""+_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED)),_typescript.default.factory.createBlock([t],!0),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(""+_pre_define.COMPONENT_CONSTRUCTOR_UPDATE_PARAMS)),void 0,[r])),_validate_ui_syntax.isStaticViewCollection.get(i)?createStaticIf(e):void 0,_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(""+_pre_define.BASE_COMPONENT_NAME),_typescript.default.factory.createIdentifier(""+_pre_define.COMPONENT_CREATE_FUNCTION)),void 0,[_typescript.default.factory.createIdentifier(e)]))],!0))}function createStaticIf(e){return _typescript.default.factory.createIfStatement(_typescript.default.factory.createPrefixUnaryExpression(_typescript.default.SyntaxKind.ExclamationToken,_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_NEEDS_UPDATE_FUNCTION)),void 0,[])),_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(e),_typescript.default.factory.createIdentifier(_pre_define.CUSTOM_COMPONENT_MARK_STATIC_FUNCTION)),void 0,[]))],!0),void 0)}function hasDollar(e){return!(!_typescript.default.isPropertyAccessExpression(e)||!matchStartWithDollar(e.name.getText()))||!(!_typescript.default.isIdentifier(e)||!matchStartWithDollar(e.getText()))}function matchStartWithDollar(e){return/^\$/.test(e)}function validateForbiddenToInitViaParam(e,t,r){isThisProperty(e,new Set([...getCollectionSet(t,_validate_ui_syntax.storageLinkCollection),...getCollectionSet(t,_validate_ui_syntax.storagePropCollection),...getCollectionSet(t,_validate_ui_syntax.consumeCollection)]))&&r.push({type:_utils.LogType.ERROR,message:`Property '${e.name.getText()}' in the custom component '${t}'`+" cannot initialize here (forbidden to specify).",pos:e.name.getStart()})}function validateNonExistentProperty(e,t,r){r.push({type:_utils.LogType.ERROR,message:`Property '${e.name.escapedText.toString()}' does not exist on type '${t}'.`,pos:e.name.getStart()})}function validateMandatoryToAssignmentViaParam(t,e,r,i){var a=this;_process_component_member.builderParamObjectCollection.get(e)&&_process_component_member.builderParamObjectCollection.get(e).size&&_process_component_member.builderParamObjectCollection.get(e).forEach(function(e){_newArrowCheck(this,a),r.has(e)||i.push({type:_utils.LogType.ERROR,message:`The property decorated with @BuilderParam '${e}' must be assigned a value .`,pos:t.getStart()})}.bind(this))}function validateMandatoryToInitViaParam(t,r,i,a){var n=this;const e=new Set([...getCollectionSet(r,_validate_ui_syntax.propCollection),...getCollectionSet(r,_validate_ui_syntax.linkCollection),...getCollectionSet(r,_validate_ui_syntax.objectLinkCollection)]);e.forEach(function(e){_newArrowCheck(this,n),i.has(e)||a.push({type:_utils.LogType.ERROR,message:`Property '${e}' in the custom component '${r}'`+" is missing (mandatory to specify).",pos:t.getStart()})}.bind(this))}function validateIllegalInitFromParent(e,t,r,i,a,n){n.push({type:_utils.LogType.ERROR,message:`The ${a} property '${i}' cannot be assigned to `+`the ${r} property '${t}'.`,pos:e.initializer.getStart()})}function validateLinkWithoutDollar(e,t){t.push({type:_utils.LogType.ERROR,message:`The @Link property '${e.name.getText()}' should initialize`+" using '$' to create a reference to a @State or @Link variable.",pos:e.initializer.getStart()})}function validateNonLinkWithDollar(e,t){t.push({type:_utils.LogType.ERROR,message:`Property '${e.name.getText()}' cannot initialize`+" using '$' to create a reference to a variable.",pos:e.initializer.getStart()})}