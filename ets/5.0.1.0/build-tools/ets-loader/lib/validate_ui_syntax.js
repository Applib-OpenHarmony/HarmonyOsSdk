"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.enumCollection=exports.dollarCollection=exports.consumeCollection=exports.componentCollection=exports.classMethodCollection=void 0,exports.getComponentSet=getComponentSet,exports.isCustomDialogClass=isCustomDialogClass,exports.isObservedClass=isObservedClass,exports.observedClassCollection=exports.objectLinkCollection=exports.moduleCollection=exports.linkCollection=exports.isStaticViewCollection=void 0,exports.preprocessExtend=preprocessExtend,exports.processSystemApi=processSystemApi,exports.regularCollection=exports.provideCollection=exports.propertyCollection=exports.propCollection=void 0,exports.resetComponentCollection=resetComponentCollection,exports.sourceReplace=sourceReplace,exports.useOSFiles=exports.storagePropCollection=exports.storageLinkCollection=exports.stateCollection=void 0,exports.validateUISyntax=validateUISyntax;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_pre_define=require("./pre_define"),_component_map=require("./component_map"),_utils=require("./utils"),_main=require("../main"),_process_ui_syntax=require("./process_ui_syntax"),_ets_checker=require("./ets_checker");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const componentCollection={entryComponent:null,previewComponent:null,customDialogs:new Set([]),customComponents:new Set([]),currentClassName:null};exports.componentCollection=componentCollection;const observedClassCollection=new Set;exports.observedClassCollection=observedClassCollection;const enumCollection=new Set;exports.enumCollection=enumCollection;const classMethodCollection=new Map;exports.classMethodCollection=classMethodCollection;const dollarCollection=new Set;exports.dollarCollection=dollarCollection;const propertyCollection=new Map;exports.propertyCollection=propertyCollection;const stateCollection=new Map;exports.stateCollection=stateCollection;const linkCollection=new Map;exports.linkCollection=linkCollection;const propCollection=new Map;exports.propCollection=propCollection;const regularCollection=new Map;exports.regularCollection=regularCollection;const storagePropCollection=new Map;exports.storagePropCollection=storagePropCollection;const storageLinkCollection=new Map;exports.storageLinkCollection=storageLinkCollection;const provideCollection=new Map;exports.provideCollection=provideCollection;const consumeCollection=new Map;exports.consumeCollection=consumeCollection;const objectLinkCollection=new Map;exports.objectLinkCollection=objectLinkCollection;const isStaticViewCollection=new Map;exports.isStaticViewCollection=isStaticViewCollection;const moduleCollection=new Set;exports.moduleCollection=moduleCollection;const useOSFiles=new Set;function validateUISyntax(e,t,o,n){var s=this;let i=[];return"app.ets"!==_path.default.basename(o)&&((n=checkComponentDecorator(e,o,n))&&(i=i.concat(n)),checkUISyntax(o,new Set([..._component_map.INNER_COMPONENT_NAMES,...componentCollection.customComponents]),t,i),componentCollection.customComponents.forEach(function(e){return _newArrowCheck(this,s),_utils.componentInfo.componentNames.add(e)}.bind(this))),i}function checkComponentDecorator(e,t,o){var s=this;const i=[],r=_typescript.default.createSourceFile(t,e,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.ETS);if(r&&r.statements&&r.statements.length){const p={entryCount:0,previewCount:0};r.statements.forEach(function(t,e,o){if(_newArrowCheck(this,s),isObservedClass(t)&&observedClassCollection.add(t.name.getText()),_typescript.default.isEnumDeclaration(t)&&t.name&&enumCollection.add(t.name.getText()),_typescript.default.isStructDeclaration(t)&&(t.name&&_typescript.default.isIdentifier(t.name)?t.decorators&&t.decorators.length?checkDecorators(t.decorators,p,t.name,i,r):(0,_utils.addLog)(_utils.LogType.WARN,"A struct should use decorator '@Component'.",t.getStart(),i,r):(0,_utils.addLog)(_utils.LogType.ERROR,"A struct must have a name.",t.getStart(),i,r)),_typescript.default.isMissingDeclaration(t)){const n=t.decorators;for(let e=0;e<n.length;e++)if(n[e]&&/struct/.test(n[e].getText())){(0,_utils.addLog)(_utils.LogType.ERROR,"Please use a valid decorator.",t.getStart(),i,r);break}}_typescript.default.isFunctionDeclaration(t)&&t.decorators&&1===t.decorators.length&&t.decorators[0].expression&&t.decorators[0].expression.getText()===_pre_define.STYLES&&(_component_map.STYLES_ATTRIBUTE.add(t.name.getText()),_component_map.GLOBAL_STYLE_FUNCTION.set(t.name.getText(),t.body),_component_map.BUILDIN_STYLE_NAMES.add(t.name.getText()))}.bind(this)),validateEntryAndPreviewCount(p,o,r.fileName,_main.projectConfig.isPreview,!!_main.projectConfig.checkEntry,i)}return i.length?i:null}function validateEntryAndPreviewCount(e,t,o,n,s,i){10<e.previewCount&&"?entry"===t&&i.push({type:_utils.LogType.ERROR,message:"A page can contain at most 10 '@Preview' decorators.",fileName:o}),1<e.entryCount&&"?entry"===t&&i.push({type:_utils.LogType.ERROR,message:"A page can't contain more than one '@Entry' decorator",fileName:o}),n&&!s&&e.previewCount<1&&1!==e.entryCount&&"?entry"===t?i.push({type:_utils.LogType.ERROR,message:`A page configured in '${_main.projectConfig.pagesJsonFileName}' must have one and only one '@Entry' `+"decorator, or at least one '@Preview' decorator.",fileName:o}):n&&!s||1===e.entryCount||"?entry"!==t||i.push({type:_utils.LogType.ERROR,message:`A page configured in '${_main.projectConfig.pagesJsonFileName}' must have one and only one '@Entry' `+"decorator.",fileName:o})}function isObservedClass(e){return!(!_typescript.default.isClassDeclaration(e)||!(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_OBSERVED_DECORATOR))}function isCustomDialogClass(e){return!(!_typescript.default.isClassDeclaration(e)||!(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_DECORATOR_CUSTOM_DIALOG))}function checkDecorators(e,o,t,n,s){var i,r=this;let p=!1;const l=t.getText();e.forEach(function(e){_newArrowCheck(this,r);var t=e.getText().replace(/\([^\(\)]*\)/,"").trim();if(_pre_define.INNER_COMPONENT_DECORATORS.has(t))switch(componentCollection.customComponents.add(l),t){case _pre_define.COMPONENT_DECORATOR_ENTRY:o.entryCount++,componentCollection.entryComponent=l;break;case _pre_define.COMPONENT_DECORATOR_PREVIEW:o.previewCount++,componentCollection.previewComponent=l;break;case _pre_define.COMPONENT_DECORATOR_COMPONENT:p=!0;break;case _pre_define.COMPONENT_DECORATOR_CUSTOM_DIALOG:componentCollection.customDialogs.add(l),p=!0}else{t=(e.expression||e).pos,e=`The struct '${l}' use invalid decorator.`;(0,_utils.addLog)(_utils.LogType.WARN,e,t,n,s)}}.bind(this)),p||(e=`The struct '${l}' should use decorator '@Component'.`,(0,_utils.addLog)(_utils.LogType.WARN,e,t.pos,n,s)),_component_map.BUILDIN_STYLE_NAMES.has(l)&&(i=`The struct '${l}' cannot have the same name `+`as the built-in attribute '${l}'.`,(0,_utils.addLog)(_utils.LogType.ERROR,i,t.pos,n,s)),_component_map.INNER_COMPONENT_NAMES.has(l)&&(i=`The struct '${l}' cannot have the same name `+`as the built-in component '${l}'.`,(0,_utils.addLog)(_utils.LogType.ERROR,i,t.pos,n,s))}function checkUISyntax(e,t,o,n){o=_typescript.default.createSourceFile(e,o,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.ETS);visitAllNode(o,o,t,n)}function visitAllNode(e,t,o,n){var s,i=this;checkAllNode(e,o,t,n),_typescript.default.isStructDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name)&&collectComponentProps(e),_typescript.default.isMethodDeclaration(e)&&(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_BUILDER_DECORATOR)&&_component_map.CUSTOM_BUILDER_METHOD.add(e.name.getText()),_typescript.default.isFunctionDeclaration(e)&&(0,_process_ui_syntax.isExtendFunction)(e)&&(s=(0,_process_ui_syntax.isExtendFunction)(e),(0,_process_ui_syntax.collectExtend)(_component_map.EXTEND_ATTRIBUTE,s,e.name.getText())),e.getChildren().forEach(function(e){return _newArrowCheck(this,i),visitAllNode(e,t,o,n)}.bind(this))}function checkAllNode(e,t,o,n){var s,i;_typescript.default.isExpressionStatement(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)&&t.has(e.expression.escapedText.toString())&&(s=e.expression.getStart(),i=`The component name must be followed by parentheses, like '${e.expression.getText()}()'.`,(0,_utils.addLog)(_utils.LogType.ERROR,i,s,n,o)),checkNoChildComponent(e,o,n),checkOneChildComponent(e,t,o,n),checkSpecificChildComponent(e,t,o,n)}function checkNoChildComponent(e,t,o){var n;_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasChild(e)&&(n=e.expression.expression.escapedText.toString(),e=e.expression.expression.getStart(),(0,_utils.addLog)(_utils.LogType.ERROR,`The component '${n}' can't have any child.`,e,o,t))}function hasChild(e){const t=e.expression.expression;return!(!_component_map.AUTOMIC_COMPONENT.has(t.escapedText.toString())||!getNextNode(e))}function getNextNode(t){if(t.parent&&_typescript.default.isBlock(t.parent)&&t.parent.statements){var o=Array.from(t.parent.statements);for(let e=0;e<o.length-1;e++){var n=o[e],s=o[e+1];if(t===n&&_typescript.default.isBlock(s))return s}}}function checkOneChildComponent(e,t,o,n){_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasNonSingleChild(e,t)&&(t=e.expression.expression.escapedText.toString(),e=e.expression.expression.getStart(),(0,_utils.addLog)(_utils.LogType.ERROR,`The component '${t}' can only have a single child component.`,e,n,o))}function hasNonSingleChild(e,t){const o=e.expression.expression;var n=getNextNode(e);if(_component_map.SINGLE_CHILD_COMPONENT.has(o.escapedText.toString())){if(!n)return!1;if(n&&n.statements){e=n.statements.length;if(!e)return!1;if(3<e)return!0;if(1<getBlockChildrenCount(n,t))return!0}}return!1}function getBlockChildrenCount(o,n){let s=0;var i=o.statements.length;for(let t=0;t<i;++t){var r=o.statements[t];if(_typescript.default.isExpressionStatement(r)&&_typescript.default.isCallExpression(r.expression)&&isForEachComponent(r.expression)&&(s+=2),_typescript.default.isIfStatement(r)&&(s+=getIfChildrenCount(r,n)),_typescript.default.isBlock(r)&&(s+=getBlockChildrenCount(r,n)),_typescript.default.isExpressionStatement(r)&&_typescript.default.isCallExpression(r.expression)){let e=r.expression;for(;e.expression;)_typescript.default.isCallExpression(e)&&_typescript.default.isIdentifier(e.expression)&&!isForEachComponent(e)&&isComponent(e,n)&&(s+=1,t+1<i&&_typescript.default.isBlock(o.statements[t+1])&&++t),e=e.expression}if(1<s)break}return s}function isComponent(e,t){return!(!_typescript.default.isIdentifier(e.expression)||!t.has(e.expression.escapedText.toString()))}function isForEachComponent(e){if(_typescript.default.isIdentifier(e.expression)){e=e.expression.escapedText.toString();return e===_pre_define.COMPONENT_FOREACH||e===_pre_define.COMPONENT_LAZYFOREACH}return!1}function getIfChildrenCount(e,t){return Math.max(getStatementCount(e.thenStatement,t),getStatementCount(e.elseStatement,t))}function getStatementCount(e,t){let o=0;return e&&(_typescript.default.isBlock(e)?o=getBlockChildrenCount(e,t):_typescript.default.isIfStatement(e)?o=getIfChildrenCount(e,t):_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&isForEachComponent(e.expression)?o=2:_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&!isForEachComponent(e.expression)&&isComponent(e.expression,t)&&(o=1)),o}function checkSpecificChildComponent(e,t,o,n){var s;_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasNonspecificChild(e,t)&&(s=e.expression.expression.escapedText.toString(),t=e.expression.expression.getStart(),e=Array.from(_component_map.SPECIFIC_CHILD_COMPONENT.get(s)).join(" and "),(0,_utils.addLog)(_utils.LogType.ERROR,`The component '${s}' can only have the child component ${e}.`,t,n,o))}function hasNonspecificChild(e,t){const o=e.expression.expression;var n=o.escapedText.toString(),e=getNextNode(e);let s=!1;if(_component_map.SPECIFIC_CHILD_COMPONENT.has(n)&&e){n=_component_map.SPECIFIC_CHILD_COMPONENT.get(n);if(s=isNonspecificChildBlock(e,n,t),s)return s}return s}function isNonspecificChildBlock(o,n,s){if(o.statements){var i=o.statements.length;for(let t=0;t<i;++t){var r=o.statements[t];if(_typescript.default.isIfStatement(r)&&isNonspecificChildIf(r,n,s))return!0;if(_typescript.default.isExpressionStatement(r)&&_typescript.default.isCallExpression(r.expression)&&isForEachComponent(r.expression)&&isNonspecificChildForEach(r.expression,n,s))return!0;if(_typescript.default.isBlock(r)&&isNonspecificChildBlock(r,n,s))return!0;if(_typescript.default.isExpressionStatement(r)&&_typescript.default.isCallExpression(r.expression)){let e=r.expression;for(;e.expression;){if(_typescript.default.isCallExpression(e)&&_typescript.default.isIdentifier(e.expression)&&!isForEachComponent(e)&&isComponent(e,s)){var p=isNonspecificChildNonForEach(r.expression,n);if(p)return p;t+1<i&&_typescript.default.isBlock(o.statements[t+1])&&++t}e=e.expression}}}}return!1}function isNonspecificChildIf(e,t,o){return isNonspecificChildIfStatement(e.thenStatement,t,o)||isNonspecificChildIfStatement(e.elseStatement,t,o)}function isNonspecificChildForEach(e,t,o){if(_typescript.default.isCallExpression(e)&&e.arguments&&1<e.arguments.length&&_typescript.default.isArrowFunction(e.arguments[1])){e=e.arguments[1].body;if(!e)return!1;if(_typescript.default.isBlock(e)&&isNonspecificChildBlock(e,t,o))return!0;if(_typescript.default.isIfStatement(e)&&isNonspecificChildIf(e,t,o))return!0;if(_typescript.default.isCallExpression(e)&&isForEachComponent(e)&&isNonspecificChildForEach(e,t,o))return!0;if(_typescript.default.isCallExpression(e)&&!isForEachComponent(e)&&isComponent(e,o)&&isNonspecificChildNonForEach(e,t))return!0}return!1}function isNonspecificChildNonForEach(e,t){return!(!_typescript.default.isIdentifier(e.expression)||t.has(e.expression.escapedText.toString()))}function isNonspecificChildIfStatement(e,t,o){return!!e&&(!(!_typescript.default.isBlock(e)||!isNonspecificChildBlock(e,t,o))||(!(!_typescript.default.isIfStatement(e)||!isNonspecificChildIf(e,t,o))||(!!(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&isForEachComponent(e.expression)&&isNonspecificChildForEach(e.expression,t,o))||!!(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&!isForEachComponent(e.expression)&&isComponent(e.expression,o)&&isNonspecificChildNonForEach(e.expression,t)))))}function collectComponentProps(e){var t=e.name.getText(),e=getComponentSet(e);propertyCollection.set(t,e.propertys),stateCollection.set(t,e.states),linkCollection.set(t,e.links),propCollection.set(t,e.props),regularCollection.set(t,e.regulars),storagePropCollection.set(t,e.storageProps),storageLinkCollection.set(t,e.storageLinks),provideCollection.set(t,e.provides),consumeCollection.set(t,e.consumes),objectLinkCollection.set(t,e.objectLinks)}function getComponentSet(e){var t=new Set,o=new Set,n=new Set,s=new Set,i=new Set,r=new Set,p=new Set,l=new Set,c=new Set,a=new Set;return traversalComponentProps(e,t,i,o,n,s,r,p,l,c,a),{propertys:t,regulars:i,states:o,links:n,props:s,storageProps:r,storageLinks:p,provides:l,consumes:c,objectLinks:a}}function traversalComponentProps(e,s,i,r,p,l,c,a,d,u,_){var C=this;let f=!0;if(e.members){const m=new Set;e.members.forEach(function(t){if(_newArrowCheck(this,C),_typescript.default.isPropertyDeclaration(t)&&_typescript.default.isIdentifier(t.name)){var o=t.name.getText();if(s.add(o),t.decorators&&t.decorators.length){f=!1;for(let e=0;e<t.decorators.length;e++){var n=t.decorators[e].getText().replace(/\(.*\)$/,"").trim();_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(n)&&(dollarCollection.add("$"+o),collectionStates(n,o,r,p,l,c,a,d,u,_))}}else i.add(o)}_typescript.default.isMethodDeclaration(t)&&t.name&&_typescript.default.isIdentifier(t.name)&&m.add(t.name.getText())}.bind(this)),classMethodCollection.set(e.name.getText(),m)}isStaticViewCollection.set(e.name.getText(),f)}function collectionStates(e,t,o,n,s,i,r,p,l,c){switch(e){case _pre_define.COMPONENT_STATE_DECORATOR:o.add(t);break;case _pre_define.COMPONENT_LINK_DECORATOR:n.add(t);break;case _pre_define.COMPONENT_PROP_DECORATOR:s.add(t);break;case _pre_define.COMPONENT_STORAGE_PROP_DECORATOR:i.add(t);break;case _pre_define.COMPONENT_STORAGE_LINK_DECORATOR:r.add(t);break;case _pre_define.COMPONENT_PROVIDE_DECORATOR:p.add(t);break;case _pre_define.COMPONENT_CONSUME_DECORATOR:l.add(t);break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:c.add(t)}}function sourceReplace(e,t){return{content:processSystemApi(preprocessExtend(e),!1,t),log:[]}}function preprocessExtend(e,s){var i=this;return e.replace(/@Extend(\s+)([^\.\s]+)\.([^\(]+)\(/gm,function(e,t,o,n){return _newArrowCheck(this,i),(0,_process_ui_syntax.collectExtend)(_component_map.EXTEND_ATTRIBUTE,o,"__"+o+"__"+n),(0,_process_ui_syntax.collectExtend)(_component_map.EXTEND_ATTRIBUTE,o,n),s&&s.add(n),`@Extend(${o})${t}function __${o}__${n}(`}.bind(this))}function processSystemApi(e,d=!1,i=null,u=!1){var _=this;let t;t=d?/(import|const)\s+(.+)\s*=\s*(\_\_importDefault\()?require\(\s*['"]@(system|ohos)\.(\S+)['"]\s*\)(\))?/g:/import\s+(.+)\s+from\s+['"]@(system|ohos)\.(\S+)['"]|import\s+(.+)\s*=\s*require\(\s*['"]@(system|ohos)\.(\S+)['"]\s*\)/g;const C=new Set;return processInnerModule(e.replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,t,o,n,s){_newArrowCheck(this,_);n=t||n,s=o||s;return i&&useOSFiles.add(i),`var ${n} = globalThis.requireNapi("${s}", true);`}.bind(this)).replace(t,function(e,t,o,n,s,i,r,p){_newArrowCheck(this,_);let l=o||i,c=n||r,a=t||s;return _pre_define.VALIDATE_MODULE.includes(a)||_ets_checker.importModuleCollection.add(a),(d||!validateWhiteListModule(l,c)||u)&&(d&&(a=o,l=s,c=i,C.add(a)),moduleCollection.add(l+"."+c),_pre_define.NATIVE_MODULE.has(l+"."+c)?e=`var ${a} = globalThis.requireNativeModule('${l}.${c}')`:l===_pre_define.SYSTEM_PLUGIN?e=`var ${a} = isSystemplugin('${c}', '${_pre_define.SYSTEM_PLUGIN}') ? `+`globalThis.systemplugin.${c} : globalThis.requireNapi('${c}')`:l===_pre_define.OHOS_PLUGIN&&(e=`var ${a} = globalThis.requireNapi('${c}') || `+`(isSystemplugin('${c}', '${_pre_define.OHOS_PLUGIN}') ? `+`globalThis.ohosplugin.${c} : isSystemplugin('${c}', '${_pre_define.SYSTEM_PLUGIN}') `+`? globalThis.systemplugin.${c} : undefined)`)),e}.bind(this)),C)}function processInnerModule(o,e){var n=this;return e.forEach(function(e){_newArrowCheck(this,n);for(var t=e.trim()+".default";o.includes(t);)o=o.replace(t,e.trim())}.bind(this)),o}exports.useOSFiles=useOSFiles;const VALIDATE_MODULE_REG=new RegExp("^("+_pre_define.VALIDATE_MODULE.join("|")+")");function validateWhiteListModule(e,t){return"ohos"===e&&VALIDATE_MODULE_REG.test(t)}function resetComponentCollection(){componentCollection.entryComponent=null,componentCollection.previewComponent=null}