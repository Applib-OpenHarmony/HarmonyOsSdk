"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=processImport;var _typescript=_interopRequireDefault(require("typescript")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_pre_define=require("./pre_define"),_validate_ui_syntax=require("./validate_ui_syntax"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function processImport(e,t,i){var n,a=this;let r,s;const o=new Map;_typescript.default.isImportDeclaration(e)||_typescript.default.isExportDeclaration(e)?(r=e.moduleSpecifier.getText().replace(/'|"/g,""),_typescript.default.isImportDeclaration(e)&&e.importClause&&e.importClause.name&&_typescript.default.isIdentifier(e.importClause.name)&&(s=e.importClause.name.escapedText.toString()),_typescript.default.isImportDeclaration(e)&&e.importClause&&e.importClause.namedBindings&&_typescript.default.isNamedImports(e.importClause.namedBindings)&&e.importClause.namedBindings.elements&&e.importClause.namedBindings.elements.forEach(function(e){_newArrowCheck(this,a),e.name&&e.propertyName&&_typescript.default.isIdentifier(e.name)&&_typescript.default.isIdentifier(e.propertyName)&&o.set(e.propertyName.escapedText.toString(),e.name.escapedText.toString())}.bind(this))):e.moduleReference&&_typescript.default.isExternalModuleReference(e.moduleReference)&&e.moduleReference.expression&&_typescript.default.isStringLiteral(e.moduleReference.expression)&&(r=e.moduleReference.expression.text,s=e.name.escapedText.toString()),r&&_path.default.extname(r)!==_pre_define.EXTNAME_ETS&&!isModule(r)&&(r+=_pre_define.EXTNAME_ETS);try{let e;e=/^(\.|\.\.)\//.test(r)?_path.default.resolve(t,r):/^\//.test(r)?r:getFileResolvePath(e,t,r,_main.projectConfig.projectPath),_fs.default.existsSync(e)&&_fs.default.statSync(e).isFile()&&(n=(0,_validate_ui_syntax.preprocessExtend)((0,_validate_ui_syntax.processSystemApi)(_fs.default.readFileSync(e,{encoding:"utf-8"}).replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b.+\\{","g"),function(e){return _newArrowCheck(this,a),e.replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b","g"),_pre_define.CLASS+" ")}.bind(this)))),visitAllNode(_typescript.default.createSourceFile(r,n,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.TS),s,o,_path.default.dirname(e),i))}catch(e){}}function visitAllNode(e,t,i,n,a){var r=this;(0,_validate_ui_syntax.isObservedClass)(e)&&_validate_ui_syntax.observedClassCollection.add(e.name.getText()),(0,_validate_ui_syntax.isCustomDialogClass)(e)&&_validate_ui_syntax.componentCollection.customDialogs.add(e.name.getText()),_typescript.default.isEnumDeclaration(e)&&e.name&&_validate_ui_syntax.enumCollection.add(e.name.getText()),_typescript.default.isClassDeclaration(e)&&_typescript.default.isIdentifier(e.name)&&isCustomComponent(e)&&(addDependencies(e,t,i),!t&&e.modifiers&&2<=e.modifiers.length&&e.modifiers[0]&&e.modifiers[0].kind===_typescript.default.SyntaxKind.ExportKeyword&&e.modifiers[1]&&e.modifiers[1].kind===_typescript.default.SyntaxKind.DefaultKeyword&&hasCollection(e.name)&&addDefaultExport(e)),_typescript.default.isExportAssignment(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)&&hasCollection(e.expression)&&(t&&setDependencies(t,_validate_ui_syntax.linkCollection.get(e.expression.escapedText.toString()),_validate_ui_syntax.propertyCollection.get(e.expression.escapedText.toString()),_validate_ui_syntax.propCollection.get(e.expression.escapedText.toString())),addDefaultExport(e)),_typescript.default.isExportDeclaration(e)&&e.exportClause&&_typescript.default.isNamedExports(e.exportClause)&&e.exportClause.elements&&e.exportClause.elements.forEach(function(t){if(_newArrowCheck(this,r),t.name&&t.propertyName&&_typescript.default.isIdentifier(t.name)&&_typescript.default.isIdentifier(t.propertyName)&&hasCollection(t.propertyName)){let e=t.name.escapedText.toString();t=t.propertyName.escapedText.toString();i.has(e)&&(e=i.get(e)),setDependencies(e,_validate_ui_syntax.linkCollection.get(t),_validate_ui_syntax.propertyCollection.get(t),_validate_ui_syntax.propCollection.get(t))}}.bind(this)),_typescript.default.isExportDeclaration(e)&&e.moduleSpecifier&&_typescript.default.isStringLiteral(e.moduleSpecifier)&&processImport(e,n,a),e.getChildren().forEach(function(e){return _newArrowCheck(this,r),visitAllNode(e,t,i,n,a)}.bind(this))}function addDependencies(e,t,i){var n=e.name.getText(),a=(0,_validate_ui_syntax.getComponentSet)(e);t&&e.modifiers&&2<=e.modifiers.length&&e.modifiers[0]&&e.modifiers[1]&&e.modifiers[0].kind===_typescript.default.SyntaxKind.ExportKeyword&&e.modifiers[1].kind===_typescript.default.SyntaxKind.DefaultKeyword?setDependencies(t,a.links,a.propertys,a.props):i.has(n)?setDependencies(i.get(n),a.links,a.propertys,a.props):setDependencies(n,a.links,a.propertys,a.props)}function addDefaultExport(e){let t;if(_typescript.default.isClassDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name))t=e.name.escapedText.toString();else{if(!(_typescript.default.isExportAssignment(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)))return;t=e.expression.escapedText.toString()}setDependencies(_pre_define.CUSTOM_COMPONENT_DEFAULT,_validate_ui_syntax.linkCollection.has(_pre_define.CUSTOM_COMPONENT_DEFAULT)?new Set([..._validate_ui_syntax.linkCollection.get(_pre_define.CUSTOM_COMPONENT_DEFAULT),..._validate_ui_syntax.linkCollection.get(t)]):_validate_ui_syntax.linkCollection.get(t),_validate_ui_syntax.propertyCollection.has(_pre_define.CUSTOM_COMPONENT_DEFAULT)?new Set([..._validate_ui_syntax.propertyCollection.get(_pre_define.CUSTOM_COMPONENT_DEFAULT),..._validate_ui_syntax.propertyCollection.get(t)]):_validate_ui_syntax.propertyCollection.get(t),_validate_ui_syntax.propCollection.has(_pre_define.CUSTOM_COMPONENT_DEFAULT)?new Set([..._validate_ui_syntax.propCollection.get(_pre_define.CUSTOM_COMPONENT_DEFAULT),..._validate_ui_syntax.propCollection.get(t)]):_validate_ui_syntax.propCollection.get(t))}function setDependencies(e,t,i,n){_validate_ui_syntax.linkCollection.set(e,t),_validate_ui_syntax.propertyCollection.set(e,i),_validate_ui_syntax.propCollection.set(e,n),_validate_ui_syntax.componentCollection.customComponents.add(e)}function hasCollection(e){return _validate_ui_syntax.linkCollection.has(e.escapedText.toString())||_validate_ui_syntax.propCollection.has(e.escapedText.toString())||_validate_ui_syntax.propertyCollection.has(e.escapedText.toString())}function isModule(e){return!/^(\.|\.\.)?\//.test(e)}function isCustomComponent(t){if(t.decorators&&t.decorators.length)for(let e=0;e<t.decorators.length;++e){const i=t.decorators[e].expression;if(_typescript.default.isIdentifier(i)&&_pre_define.CUSTOM_DECORATOR_NAME.has(i.escapedText.toString()))return!0}return!1}function isPackageJsonEntry(t){var i=_path.default.join(t,_pre_define.PACKAGE_JSON);if(_fs.default.existsSync(i)){let e;try{e=JSON.parse(_fs.default.readFileSync(i).toString()).main}catch(e){return!1}if("string"==typeof e&&_fs.default.existsSync(_path.default.join(t,e)))return!0}}function getPackageJsonEntry(e){return _path.default.join(e,JSON.parse(_fs.default.readFileSync(_path.default.join(e,_pre_define.PACKAGE_JSON)).toString()).main)}function getModuleFilePath(e){return e&&_path.default.extname(e)!==_pre_define.EXTNAME_ETS&&isModule(e)&&(e+=_pre_define.EXTNAME_ETS),e}function getFileResolvePath(e,t,i,n){var a=getModuleFilePath(i),r=_path.default.join(n,a);if(_fs.default.existsSync(r))return r;a=_path.default.join(n,"../../../../../",a);if(_fs.default.existsSync(a))return a;let s=t;for(;!_fs.default.existsSync(e)&&(e=_path.default.join(s,_pre_define.NODE_MODULES,i),_fs.default.existsSync(e+_pre_define.EXTNAME_ETS)?e+=_pre_define.EXTNAME_ETS:isPackageJsonEntry(e)?e=getPackageJsonEntry(e):_fs.default.existsSync(_path.default.join(e,_pre_define.INDEX_ETS))&&(e=_path.default.join(e,_pre_define.INDEX_ETS)),s!==_path.default.parse(s).root);)s=_path.default.dirname(s);return e}