"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createReference=createReference,exports.isProperty=isProperty,exports.processComponentClass=processComponentClass;var _typescript=_interopRequireDefault(require("typescript")),_pre_define=require("./pre_define"),_component_map=require("./component_map"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_constructor=require("./process_component_constructor"),_process_component_member=require("./process_component_member"),_process_component_build=require("./process_component_build"),_utils=require("./utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function processComponentClass(e,t,r,s){validateInheritClass(e,r);s=processMembers(e.members,e.name,t,r,s,checkPreview(e));return _typescript.default.factory.createClassDeclaration(void 0,e.modifiers,e.name,e.typeParameters,updateHeritageClauses(e),s)}function checkPreview(t){let r=!1;if(t&&t.decorators)for(let e=0;e<t.decorators.length;e++)if(t.decorators[e].getText().replace(/\([^\(\)]*\)/,"").trim()===_pre_define.COMPONENT_DECORATOR_PREVIEW){r=!0;break}return r}function processMembers(e,s,a,o,i,p){var n=this;const c={count:0};let _=(0,_process_component_constructor.getInitConstructor)(e);const d=[],f=new Map,l=[],u=[],y={hasController:!_validate_ui_syntax.componentCollection.customDialogs.has(s.getText())},E=_typescript.default.factory.createInterfaceDeclaration(void 0,void 0,s.getText()+_pre_define.INTERFACE_NAME_SUFFIX,void 0,void 0,[]);return e.forEach(function(e){_newArrowCheck(this,n);let t;if(_typescript.default.isPropertyDeclaration(e)){addPropertyMember(e,d,i);const r=(0,_process_component_member.processMemberVariableDecorators)(s,e,_,f,y,o,i,a,p,E);t=r.isItemUpdate()?r.getProperity():e,r.getVariableGet()&&d.push(r.getVariableGet()),r.getVariableSet()&&d.push(r.getVariableSet()),r.isCtorUpdate()&&(_=r.getCtor()),r.getUpdateParams()&&l.push(r.getUpdateParams()),r.isDeleteParams()&&u.push(e),r.getControllerSet()&&d.push(r.getControllerSet())}_typescript.default.isMethodDeclaration(e)&&e.name&&(t=processComponentMethod(e,s,a,o,c)),t&&d.push(t)}.bind(this)),_component_map.INTERFACE_NODE_SET.add(E),validateBuildMethodCount(c,s,o),validateHasController(s,y,o),d.unshift(addDeleteParamsFunc(u)),d.unshift(addUpdateParamsFunc(l,s)),d.unshift((0,_process_component_constructor.addConstructor)(_,f,s)),d}function addPropertyMember(e,r,s){const a=e;let o;var i=a.type;if(a.decorators&&0!==a.decorators.length){if(a.decorators)for(let t=0;t<a.decorators.length;t++){let e;switch(a.decorators[t].getText().replace(/\(.*\)$/,"").trim()){case _pre_define.COMPONENT_STATE_DECORATOR:case _pre_define.COMPONENT_PROVIDE_DECORATOR:e=_typescript.default.factory.createTypeReferenceNode((0,_process_component_member.isSimpleType)(i,s)?_pre_define.OBSERVED_PROPERTY_SIMPLE:_pre_define.OBSERVED_PROPERTY_OBJECT,[i]);break;case _pre_define.COMPONENT_LINK_DECORATOR:case _pre_define.COMPONENT_CONSUME_DECORATOR:e=_typescript.default.factory.createTypeReferenceNode((0,_process_component_member.isSimpleType)(i,s)?_pre_define.SYNCHED_PROPERTY_SIMPLE_TWO_WAY:_pre_define.SYNCHED_PROPERTY_SIMPLE_ONE_WAY,[i]);break;case _pre_define.COMPONENT_PROP_DECORATOR:e=_typescript.default.factory.createTypeReferenceNode(_pre_define.SYNCHED_PROPERTY_SIMPLE_ONE_WAY,[i]);break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:e=_typescript.default.factory.createTypeReferenceNode(_pre_define.SYNCHED_PROPERTY_NESED_OBJECT,[i]);break;case _pre_define.COMPONENT_STORAGE_PROP_DECORATOR:case _pre_define.COMPONENT_STORAGE_LINK_DECORATOR:e=_typescript.default.factory.createTypeReferenceNode(_pre_define.OBSERVED_PROPERTY_ABSTRACT,[i])}o=createPropertyDeclaration(a,e,!1),o&&r.push(o)}}else o=createPropertyDeclaration(a,i,!0),r.push(o)}function createPropertyDeclaration(e,t,r){let s="";r||(s="__");r=_typescript.default.factory.createModifier(_typescript.default.SyntaxKind.PrivateKeyword);return _typescript.default.factory.updatePropertyDeclaration(e,void 0,e.modifiers||[r],s+e.name.getText(),e.questionToken,t,void 0)}function processComponentMethod(e,t,r,s,a){let o=e;var i=e.name.getText();if(i===_pre_define.COMPONENT_BUILD_FUNCTION)a.count=a.count+1,o=processBuildMember(e,r,s),_process_component_member.curPropMap.clear();else if(e.body&&_typescript.default.isBlock(e.body))if(i===_pre_define.COMPONENT_TRANSITION_FUNCTION)o=_typescript.default.factory.updateMethodDeclaration(e,e.decorators,e.modifiers,e.asteriskToken,e.name,e.questionToken,e.typeParameters,e.parameters,e.type,(0,_process_component_build.processComponentBlock)(e.body,!1,s,!0));else if((0,_utils.hasDecorator)(e,_pre_define.COMPONENT_BUILDER_DECORATOR))_component_map.CUSTOM_BUILDER_METHOD.add(i),o=_typescript.default.factory.updateMethodDeclaration(e,void 0,e.modifiers,e.asteriskToken,e.name,e.questionToken,e.typeParameters,e.parameters,e.type,(0,_process_component_build.processComponentBlock)(e.body,!1,s));else if((0,_utils.hasDecorator)(e,_pre_define.COMPONENT_STYLES_DECORATOR))return void(e.parameters&&0===e.parameters.length?(_component_map.INNER_STYLE_FUNCTION.set(i,e.body),_component_map.STYLES_ATTRIBUTE.add(i),_component_map.BUILDIN_STYLE_NAMES.add(i),_process_component_member.decoratorParamSet.add(_pre_define.STYLES)):s.push({type:_utils.LogType.ERROR,message:"@Styles can't have parameters.",pos:e.getStart()}));return o}function processBuildMember(e,r,s){e.parameters.length&&s.push({type:_utils.LogType.ERROR,message:"The 'build' method can not have arguments.",pos:e.getStart()});e=(0,_process_component_build.processComponentBuild)(e,s);return _typescript.default.visitNode(e,function e(t){isGeometryView(t)&&(t=processGeometryView(t,s));isProperty(t)&&(t=createReference(t));if(_typescript.default.isPropertyAccessExpression(t)&&_typescript.default.isIdentifier(t.name)&&_process_component_member.stateObjectCollection.has(t.name.escapedText.toString())&&t.parent&&_typescript.default.isCallExpression(t.parent)&&_typescript.default.isPropertyAccessExpression(t.parent.expression)&&t.parent.expression.name.escapedText.toString()!==_pre_define.FOREACH_GET_RAW_OBJECT)return _typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.FOREACH_OBSERVED_OBJECT),_typescript.default.factory.createIdentifier(_pre_define.FOREACH_GET_RAW_OBJECT)),void 0,[t]);return _typescript.default.visitEachChild(t,e,r)})}function isGeometryView(e){if(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)){e=e.expression;const t=e.expression;e=e.arguments;if(_typescript.default.isPropertyAccessExpression(t)&&_typescript.default.isIdentifier(t.expression)&&t.expression.escapedText.toString()===_pre_define.GEOMETRY_VIEW&&_typescript.default.isIdentifier(t.name)&&t.name.escapedText.toString()===_pre_define.COMPONENT_CREATE_FUNCTION&&e&&1===e.length&&(_typescript.default.isArrowFunction(e[0])||_typescript.default.isFunctionExpression(e[0])))return!0}return!1}function processGeometryView(e,t){var r=e.expression,s=r.arguments[0];return _typescript.default.factory.updateExpressionStatement(e,_typescript.default.factory.updateCallExpression(r,r.expression,void 0,[_typescript.default.factory.createArrowFunction(void 0,void 0,s.parameters,void 0,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.EqualsGreaterThanToken),getGeometryReaderFunctionBlock(s,t))]))}function getGeometryReaderFunctionBlock(e,t){let r;return _typescript.default.isBlock(e.body)?r=e.body:_typescript.default.isArrowFunction(e)&&_typescript.default.isCallExpression(e.body)&&(r=_typescript.default.factory.createBlock([_typescript.default.factory.createExpressionStatement(e.body)])),(0,_process_component_build.processComponentBlock)(r,!1,t)}function updateHeritageClauses(e){const t=[];var r=_typescript.default.factory.createHeritageClause(_typescript.default.SyntaxKind.ExtendsKeyword,[_typescript.default.factory.createExpressionWithTypeArguments(_typescript.default.factory.createIdentifier(_pre_define.BASE_COMPONENT_NAME),[])]);return e.heritageClauses&&t.push(...e.heritageClauses),t.push(r),_typescript.default.factory.createNodeArray(t)}function isProperty(e){if(e.parent&&_typescript.default.isObjectLiteralExpression(e.parent)&&e.parent.parent&&_typescript.default.isCallExpression(e.parent.parent)&&_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(e.name)){if(_typescript.default.isIdentifier(e.parent.parent.expression)&&!_component_map.BUILDIN_STYLE_NAMES.has(e.parent.parent.expression.escapedText.toString())&&_validate_ui_syntax.componentCollection.customComponents.has(e.parent.parent.expression.escapedText.toString()))return!0;if(_typescript.default.isPropertyAccessExpression(e.parent.parent.expression)&&_typescript.default.isIdentifier(e.parent.parent.expression.expression)&&_validate_ui_syntax.componentCollection.customComponents.has(e.parent.parent.expression.name.escapedText.toString()))return!0}return!1}function createReference(e){const t=getParentNode(e,_validate_ui_syntax.linkCollection).slice(1),r=e.name;let s;if(t&&_typescript.default.isPropertyAssignment(e)&&_typescript.default.isIdentifier(r)&&t.includes(r.escapedText.toString())){var a=/^\$/g;const o=e.initializer;_typescript.default.isIdentifier(o)&&o.escapedText.toString().match(a)?t.includes(r.escapedText.toString())&&(s=o.escapedText.toString().replace(a,"")):_typescript.default.isPropertyAccessExpression(o)&&o.expression&&o.expression.kind===_typescript.default.SyntaxKind.ThisKeyword&&_typescript.default.isIdentifier(o.name)&&o.name.escapedText.toString().match(a)&&t.includes(r.escapedText.toString())&&(s=o.name.escapedText.toString().replace(a,"")),s&&(e=addDoubleUnderline(e,r,s))}return e}function addDoubleUnderline(e,t,r){return _typescript.default.factory.updatePropertyAssignment(e,t,_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier("__"+r)))}function getParentNode(e,t){const r=e.parent.parent.expression;let s=new Set,a;return _typescript.default.isIdentifier(r)?(a=r.escapedText.toString(),s=t.get(a)):_typescript.default.isPropertyAccessExpression(r)&&(a=r.name.escapedText.toString(),s=t.get(a)),s=s||new Set,[a,...s]}function addUpdateParamsFunc(e,t){return createParamsInitBlock(_pre_define.COMPONENT_CONSTRUCTOR_UPDATE_PARAMS,e,t)}function addDeleteParamsFunc(e){var r=this;const s=[];e.forEach(function(e){_newArrowCheck(this,r);const t=e.name;e=_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier("__"+t.escapedText.toString())),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_DELETE_PARAMS)),void 0,[]));s.push(e)}.bind(this));e=_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.CREATE_CONSTRUCTOR_SUBSCRIBER_MANAGER),_typescript.default.factory.createIdentifier(_pre_define.CREATE_CONSTRUCTOR_GET_FUNCTION)),void 0,[]),_typescript.default.factory.createIdentifier(_pre_define.CREATE_CONSTRUCTOR_DELETE_FUNCTION)),void 0,[_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(_pre_define.ABOUT_TO_BE_DELETE_FUNCTION_ID)),void 0,[])]));return s.push(e),createParamsInitBlock(_pre_define.COMPONENT_CONSTRUCTOR_DELETE_PARAMS,s)}function createParamsInitBlock(e,t,r){return _typescript.default.factory.createMethodDeclaration(void 0,void 0,void 0,_typescript.default.factory.createIdentifier(e),void 0,void 0,[_typescript.default.factory.createParameterDeclaration(void 0,void 0,void 0,e===_pre_define.COMPONENT_CONSTRUCTOR_DELETE_PARAMS?void 0:_typescript.default.factory.createIdentifier(_pre_define.CREATE_CONSTRUCTOR_PARAMS),void 0,e===_pre_define.COMPONENT_CONSTRUCTOR_DELETE_PARAMS?void 0:_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(r.getText()+_pre_define.INTERFACE_NAME_SUFFIX),void 0),void 0)],void 0,_typescript.default.factory.createBlock(t,!0))}function validateBuildMethodCount(e,t,r){1!==e.count&&r.push({type:_utils.LogType.ERROR,message:`struct '${t.getText()}' must be at least or at most one 'build' method.`,pos:t.getStart()})}function validateInheritClass(e,t){e.heritageClauses&&t.push({type:_utils.LogType.ERROR,message:"@Component should not be inherit other Classes.",pos:e.heritageClauses.pos})}function validateHasController(e,t,r){t.hasController||r.push({type:_utils.LogType.ERROR,message:"@CustomDialog component should have a property of the CustomDialogController type.",pos:e.pos})}