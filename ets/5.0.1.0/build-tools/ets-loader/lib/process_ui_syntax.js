"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.collectExtend=collectExtend,exports.contextGlobal=void 0,exports.isExtendFunction=isExtendFunction,exports.processUISyntax=processUISyntax,exports.resetLog=resetLog,exports.transformLog=void 0;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_class=require("./process_component_class"),_process_import=_interopRequireDefault(require("./process_import")),_pre_define=require("./pre_define"),_utils=require("./utils"),_process_component_build=require("./process_component_build"),_component_map=require("./component_map"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const transformLog=new _utils.FileLog;exports.transformLog=transformLog;let contextGlobal;function processUISyntax(t,p=!1){var e=this;return function(s){var o=this;_newArrowCheck(this,e),exports.contextGlobal=contextGlobal=s;let n;return function(e){var r=this;if(_newArrowCheck(this,o),n=_path.default.resolve(_path.default.dirname(e.fileName)),process.env.compiler!==_pre_define.BUILD_ON)return e;{if(!p&&("app.ets"===_path.default.basename(e.fileName)||/\.ts$/.test(e.fileName)))return e=_typescript.default.visitEachChild(e,i,s);e=createEntryNode(transformLog.sourceFile=e,s),e=_typescript.default.visitEachChild(e,a,s),_component_map.GLOBAL_STYLE_FUNCTION.forEach(function(e,t){_newArrowCheck(this,r),_component_map.BUILDIN_STYLE_NAMES.delete(t)}.bind(this)),_component_map.GLOBAL_STYLE_FUNCTION.clear();const t=Array.from(e.statements);return _component_map.INTERFACE_NODE_SET.forEach(function(e){_newArrowCheck(this,r),t.unshift(e)}.bind(this)),e=_typescript.default.factory.updateSourceFile(e,t),_component_map.INTERFACE_NODE_SET.clear(),e}}.bind(this);function a(e){var r=this;return _typescript.default.isImportDeclaration(e)||_typescript.default.isImportEqualsDeclaration(e)?(0,_process_import.default)(e,n,transformLog.errors):_typescript.default.isStructDeclaration(e)?(_validate_ui_syntax.componentCollection.currentClassName=e.name.getText(),e=(0,_process_component_class.processComponentClass)(e,s,transformLog.errors,t),_validate_ui_syntax.componentCollection.currentClassName=null,_component_map.INNER_STYLE_FUNCTION.forEach(function(e,t){_newArrowCheck(this,r),_component_map.BUILDIN_STYLE_NAMES.delete(t)}.bind(this)),_component_map.INNER_STYLE_FUNCTION.clear()):_typescript.default.isFunctionDeclaration(e)?(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_EXTEND_DECORATOR)?e=processExtend(e,transformLog.errors):(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_BUILDER_DECORATOR)&&e.name&&e.body&&_typescript.default.isBlock(e.body)?(_component_map.CUSTOM_BUILDER_METHOD.add(e.name.getText()),e=_typescript.default.factory.updateFunctionDeclaration(e,void 0,e.modifiers,e.asteriskToken,e.name,e.typeParameters,e.parameters,e.type,(0,_process_component_build.processComponentBlock)(e.body,!1,transformLog.errors))):(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_STYLES_DECORATOR)&&(0===e.parameters.length?e=void 0:transformLog.errors.push({type:_utils.LogType.ERROR,message:"@Styles can't have parameters.",pos:e.getStart()})):isResource(e)?e=processResourceData(e):isWorker(e)?e=processWorker(e):isAnimateTo(e)&&(e=processAnimateTo(e)),_typescript.default.visitEachChild(e,a,s)}function i(e){return isResource(e)&&(e=processResourceData(e)),_typescript.default.visitEachChild(e,i,s)}}.bind(this)}function isResource(e){return _typescript.default.isCallExpression(e)&&_typescript.default.isIdentifier(e.expression)&&(e.expression.escapedText.toString()===_pre_define.RESOURCE||e.expression.escapedText.toString()===_pre_define.RESOURCE_RAWFILE)&&0<e.arguments.length}function isAnimateTo(e){return _typescript.default.isCallExpression(e)&&_typescript.default.isIdentifier(e.expression)&&e.expression.escapedText.toString()===_pre_define.ATTRIBUTE_ANIMATETO}function processResourceData(e){if(_typescript.default.isStringLiteral(e.arguments[0])){if(e.expression.getText()===_pre_define.RESOURCE_RAWFILE)return createResourceParam(0,_pre_define.RESOURCE_TYPE.rawfile,[e.arguments[0]]);var t=e.arguments[0].text.trim().split(".");if(validateResourceData(t,_main.resources,e.arguments[0].getStart())){var r=_pre_define.RESOURCE_TYPE[t[1]];return createResourceParam(_main.resources[t[0]][t[1]][t[2]],r,Array.from(e.arguments).slice(1))}}return e}function createResourceParam(e,t,r){return _typescript.default.factory.createObjectLiteralExpression([_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createStringLiteral(_pre_define.RESOURCE_NAME_ID),_typescript.default.factory.createNumericLiteral(e)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createStringLiteral(_pre_define.RESOURCE_NAME_TYPE),_typescript.default.factory.createNumericLiteral(t)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier(_pre_define.RESOURCE_NAME_PARAMS),_typescript.default.factory.createArrayLiteralExpression(r,!1))],!1)}function validateResourceData(e,t,r){if(3!==e.length)transformLog.errors.push({type:_utils.LogType.ERROR,message:"The input parameter is not supported.",pos:r});else if(t[e[0]])if(t[e[0]][e[1]]){if(t[e[0]][e[1]][e[2]])return!0;transformLog.errors.push({type:_utils.LogType.ERROR,message:`Value '${e[2]}' does not exist on type 'typeof ${e[1]}'.`,pos:r})}else transformLog.errors.push({type:_utils.LogType.ERROR,message:`Value '${e[1]}' does not exist on type 'typeof ${e[0]}'.`,pos:r});else transformLog.errors.push({type:_utils.LogType.ERROR,message:`The value of '${e[0]}' is invalid.`,pos:r});return!1}function isWorker(e){return _typescript.default.isNewExpression(e)&&_typescript.default.isPropertyAccessExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.name)&&e.expression.name.escapedText.toString()===_pre_define.WORKER_OBJECT}function processWorker(e){if(e.arguments.length&&_typescript.default.isStringLiteral(e.arguments[0])){const r=Array.from(e.arguments),s=e.arguments[0].text;var t=_typescript.default.factory.createStringLiteral(s.replace(/\.ts$/,".js"));return r.splice(0,1,t),_typescript.default.factory.updateNewExpression(e,e.expression,e.typeArguments,r)}return e}function processAnimateTo(e){return _typescript.default.factory.updateCallExpression(e,_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createIdentifier(_pre_define.GLOBAL_CONTEXT),_typescript.default.factory.createIdentifier(_pre_define.ATTRIBUTE_ANIMATETO)),e.typeArguments,e.arguments)}function processExtend(t,r){var s=isExtendFunction(t);if(s&&t.body&&t.body.statements.length){var o=[],n=t.body.statements[0].expression,n=_typescript.default.factory.createExpressionStatement(processExtendBody(n));(0,_process_component_build.bindComponentAttr)(n,_typescript.default.factory.createIdentifier(s),o,r);let e;return t.name.getText().startsWith("__"+s+"__")?e=t.name.getText():(e="__"+s+"__"+t.name.getText(),collectExtend(_component_map.EXTEND_ATTRIBUTE,s,t.name.escapedText.toString())),_typescript.default.factory.updateFunctionDeclaration(t,void 0,t.modifiers,t.asteriskToken,_typescript.default.factory.createIdentifier(e),t.typeParameters,t.parameters,t.type,_typescript.default.factory.updateBlock(t.body,o))}}function processExtendBody(e){switch(e.kind){case _typescript.default.SyntaxKind.CallExpression:return _typescript.default.factory.createCallExpression(processExtendBody(e.expression),void 0,e.arguments);case _typescript.default.SyntaxKind.PropertyAccessExpression:return _typescript.default.factory.createPropertyAccessExpression(processExtendBody(e.expression),e.name);case _typescript.default.SyntaxKind.Identifier:return _typescript.default.factory.createIdentifier(e.escapedText.toString().replace(_pre_define.INSTANCE,""))}}function collectExtend(e,t,r){e.has(t)?e.get(t).add(r):e.set(t,new Set([r]))}function isExtendFunction(e){return e.decorators&&e.decorators[0].expression&&e.decorators[0].expression.expression&&e.decorators[0].expression.expression.escapedText.toString()===_pre_define.CHECK_COMPONENT_EXTEND_DECORATOR&&e.decorators[0].expression.arguments?e.decorators[0].expression.arguments[0].escapedText.toString():null}function createEntryNode(e,t){if(_validate_ui_syntax.componentCollection.entryComponent){var r=createEntryFunction(_validate_ui_syntax.componentCollection.entryComponent,t);return t.factory.updateSourceFile(e,[...e.statements,r])}if(_validate_ui_syntax.componentCollection.previewComponent){r=createEntryFunction(_validate_ui_syntax.componentCollection.previewComponent,t);return t.factory.updateSourceFile(e,[...e.statements,r])}return e}function createEntryFunction(e,t){return t.factory.createExpressionStatement(t.factory.createCallExpression(t.factory.createIdentifier(_pre_define.PAGE_ENTRY_FUNCTION_NAME),void 0,[t.factory.createNewExpression(t.factory.createIdentifier(e),void 0,[t.factory.createStringLiteral((++_utils.componentInfo.id).toString()),t.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED),t.factory.createObjectLiteralExpression([],!1)])]))}function resetLog(){transformLog.errors=[]}exports.contextGlobal=contextGlobal;