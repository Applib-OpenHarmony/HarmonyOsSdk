"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.enumCollection=exports.dollarCollection=exports.consumeCollection=exports.componentCollection=exports.classMethodCollection=void 0,exports.getComponentSet=getComponentSet,exports.isCustomDialogClass=isCustomDialogClass,exports.isObservedClass=isObservedClass,exports.observedClassCollection=exports.objectLinkCollection=exports.moduleCollection=exports.linkCollection=exports.isStaticViewCollection=void 0,exports.preprocessExtend=preprocessExtend,exports.processSystemApi=processSystemApi,exports.regularCollection=exports.provideCollection=exports.propertyCollection=exports.propCollection=void 0,exports.resetComponentCollection=resetComponentCollection,exports.sourceReplace=sourceReplace,exports.storagePropCollection=exports.storageLinkCollection=exports.stateCollection=void 0,exports.validateUISyntax=validateUISyntax;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_pre_define=require("./pre_define"),_component_map=require("./component_map"),_utils=require("./utils"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(o="Object"===o&&e.constructor?e.constructor.name:o)||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=new Array(t);o<t;o++)n[o]=e[o];return n}var parser=require("../syntax_parser/dist/exclude_comment.js"),componentCollection={entryComponent:null,previewComponent:null,customDialogs:new Set([]),customComponents:new Set([]),currentClassName:null};exports.componentCollection=componentCollection;var observedClassCollection=new Set;exports.observedClassCollection=observedClassCollection;var enumCollection=new Set;exports.enumCollection=enumCollection;var classMethodCollection=new Map;exports.classMethodCollection=classMethodCollection;var dollarCollection=new Set;exports.dollarCollection=dollarCollection;var propertyCollection=new Map;exports.propertyCollection=propertyCollection;var stateCollection=new Map;exports.stateCollection=stateCollection;var linkCollection=new Map;exports.linkCollection=linkCollection;var propCollection=new Map;exports.propCollection=propCollection;var regularCollection=new Map;exports.regularCollection=regularCollection;var storagePropCollection=new Map;exports.storagePropCollection=storagePropCollection;var storageLinkCollection=new Map;exports.storageLinkCollection=storageLinkCollection;var provideCollection=new Map;exports.provideCollection=provideCollection;var consumeCollection=new Map;exports.consumeCollection=consumeCollection;var objectLinkCollection=new Map;exports.objectLinkCollection=objectLinkCollection;var isStaticViewCollection=new Map;exports.isStaticViewCollection=isStaticViewCollection;var moduleCollection=new Set;function validateUISyntax(e,t,o,n){var r=this,s=[];return"app.ets"!==_path.default.basename(o)&&((n=checkComponentDecorator(e,o,n))&&(s=s.concat(n)),checkUISyntax(o,new Set([].concat(_toConsumableArray(_component_map.INNER_COMPONENT_NAMES),_toConsumableArray(componentCollection.customComponents))),t,s),componentCollection.customComponents.forEach(function(e){return _newArrowCheck(this,r),_utils.componentInfo.componentNames.add(e)}.bind(this))),s}function checkComponentDecorator(e,t,o){var i,a=this,c=[],p=_typescript.default.createSourceFile(t,e,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.TS);return p&&p.statements&&p.statements.length&&(i={entryCount:0,previewCount:0},p.statements.forEach(function(e,t,o){var n;if(_newArrowCheck(this,a),isObservedClass(e)&&observedClassCollection.add(e.name.getText()),_typescript.default.isEnumDeclaration(e)&&e.name&&enumCollection.add(e.name.getText()),isStruct(e)&&(t+1<o.length&&_typescript.default.isExpressionStatement(o[t+1])&&o[t+1].expression&&_typescript.default.isIdentifier(o[t+1].expression)?_typescript.default.isExportAssignment(e)&&hasComponentDecorator(e)?checkDecorators(e,i,o[t+1],c,p):0<t&&hasComponentDecorator(o[t-1])?checkDecorators(o[t-1],i,o[t+1],c,p):(n=e.expression.getStart(),(0,_utils.addLog)(_utils.LogType.WARN,"A struct should use decorator '@Component'.",n,c,p)):(n=e.expression.getStart(),(0,_utils.addLog)(_utils.LogType.ERROR,"A struct must have a name.",n,c,p))),_typescript.default.isMissingDeclaration(e))for(var r=e.decorators,s=0;s<r.length;s++)if(r[s]&&/struct/.test(r[s].getText())){(0,_utils.addLog)(_utils.LogType.ERROR,"Please use a valid decorator.",e.getStart(),c,p);break}_typescript.default.isFunctionDeclaration(e)&&e.decorators&&1===e.decorators.length&&e.decorators[0].expression&&e.decorators[0].expression.getText()===_pre_define.STYLES&&(_component_map.STYLES_ATTRIBUTE.add(e.name.getText()),_component_map.GLOBAL_STYLE_FUNCTION.set(e.name.getText(),e.body),_component_map.BUILDIN_STYLE_NAMES.add(e.name.getText()))}.bind(this)),validateEntryAndPreviewCount(i,o,p.fileName,_main.projectConfig.isPreview,c)),c.length?c:null}function validateEntryAndPreviewCount(e,t,o,n,r){10<e.previewCount&&"?entry"===t&&r.push({type:_utils.LogType.ERROR,message:"A page can contain at most 10 '@Preview' decorators.",fileName:o}),1<e.entryCount&&"?entry"===t&&r.push({type:_utils.LogType.ERROR,message:"A page can't contain more than one '@Entry' decorator",fileName:o}),n&&e.previewCount<1&&1!==e.entryCount&&"?entry"===t?r.push({type:_utils.LogType.ERROR,message:"A page configured in 'config.json' must have one and only one '@Entry' decorator, or at least one '@Preview' decorator.",fileName:o}):n||1===e.entryCount||"?entry"!==t||r.push({type:_utils.LogType.ERROR,message:"A page configured in 'config.json' must have one and only one '@Entry' decorator.",fileName:o})}function isObservedClass(e){return!(!_typescript.default.isClassDeclaration(e)||!(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_OBSERVED_DECORATOR))}function isCustomDialogClass(e){return!(!_typescript.default.isClassDeclaration(e)||!(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_DECORATOR_CUSTOM_DIALOG))}function isStruct(e){return!(!_typescript.default.isExpressionStatement(e)&&!_typescript.default.isExportAssignment(e)||!e.expression||!_typescript.default.isIdentifier(e.expression)||e.expression.getText()!==_pre_define.STRUCT)}function hasComponentDecorator(e){return!(!_typescript.default.isMissingDeclaration(e)&&!_typescript.default.isExportAssignment(e)||!e.decorators||!e.decorators.length)}function checkDecorators(e,o,t,n,r){var s,i=this,a=!1,c=t.getText();e.decorators.forEach(function(e){_newArrowCheck(this,i);var t=e.getText().replace(/\((.|\n)*\)/,"").trim();if(_pre_define.INNER_COMPONENT_DECORATORS.has(t))switch(componentCollection.customComponents.add(c),t){case _pre_define.COMPONENT_DECORATOR_ENTRY:o.entryCount++,componentCollection.entryComponent=c;break;case _pre_define.COMPONENT_DECORATOR_PREVIEW:o.previewCount++,componentCollection.previewComponent=c;break;case _pre_define.COMPONENT_DECORATOR_COMPONENT:a=!0;break;case _pre_define.COMPONENT_DECORATOR_CUSTOM_DIALOG:componentCollection.customDialogs.add(c),a=!0}else{t=(e.expression||e).pos,e="The struct '".concat(c,"' use invalid decorator.");(0,_utils.addLog)(_utils.LogType.WARN,e,t,n,r)}}.bind(this)),a||(e="The struct '".concat(c,"' should use decorator '@Component'."),(0,_utils.addLog)(_utils.LogType.WARN,e,t.pos,n,r)),_component_map.BUILDIN_STYLE_NAMES.has(c)&&(s="The struct '".concat(c,"' cannot have the same name ")+"as the built-in attribute '".concat(c,"'."),(0,_utils.addLog)(_utils.LogType.ERROR,s,t.pos,n,r)),_component_map.INNER_COMPONENT_NAMES.has(c)&&(s="The struct '".concat(c,"' cannot have the same name ")+"as the built-in component '".concat(c,"'."),(0,_utils.addLog)(_utils.LogType.ERROR,s,t.pos,n,r))}function checkUISyntax(e,t,o,n){o=_typescript.default.createSourceFile(e,o,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.TS);visitAllNode(o,o,t,n)}function visitAllNode(e,t,o,n){var r=this;checkAllNode(e,o,t,n),_typescript.default.isClassDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name)&&collectComponentProps(e),e.getChildren().forEach(function(e){return _newArrowCheck(this,r),visitAllNode(e,t,o,n)}.bind(this))}function checkAllNode(e,t,o,n){var r,s;_typescript.default.isExpressionStatement(e)&&e.expression&&_typescript.default.isIdentifier(e.expression)&&t.has(e.expression.escapedText.toString())&&(r=e.expression.getStart(),s="The component name must be followed by parentheses, like '".concat(e.expression.getText(),"()'."),(0,_utils.addLog)(_utils.LogType.ERROR,s,r,n,o)),checkNoChildComponent(e,o,n),checkOneChildComponent(e,t,o,n),checkSpecificChildComponent(e,t,o,n)}function checkNoChildComponent(e,t,o){var n;_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasChild(e)&&(n=e.expression.expression.escapedText.toString(),e=e.expression.expression.getStart(),n="The component '".concat(n,"' can't have any child."),(0,_utils.addLog)(_utils.LogType.ERROR,n,e,o,t))}function hasChild(e){var t=e.expression.expression;return!(!_component_map.AUTOMIC_COMPONENT.has(t.escapedText.toString())||!getNextNode(e))}function getNextNode(e){if(e.parent&&_typescript.default.isBlock(e.parent)&&e.parent.statements)for(var t=Array.from(e.parent.statements),o=0;o<t.length-1;o++){var n=t[o],r=t[o+1];if(e===n&&_typescript.default.isBlock(r))return r}}function checkOneChildComponent(e,t,o,n){_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasNonSingleChild(e,t)&&(t=e.expression.expression.escapedText.toString(),e=e.expression.expression.getStart(),t="The component '".concat(t,"' can only have a single child component."),(0,_utils.addLog)(_utils.LogType.ERROR,t,e,n,o))}function hasNonSingleChild(e,t){var o=e.expression.expression,e=getNextNode(e);if(_component_map.SINGLE_CHILD_COMPONENT.has(o.escapedText.toString())){if(!e)return!1;if(e&&e.statements){o=e.statements.length;if(!o)return!1;if(3<o)return!0;if(1<getBlockChildrenCount(e,t))return!0}}return!1}function getBlockChildrenCount(e,t){for(var o=0,n=e.statements.length,r=0;r<n;++r){var s=e.statements[r];if(_typescript.default.isExpressionStatement(s)&&_typescript.default.isCallExpression(s.expression)&&isForEachComponent(s.expression)&&(o+=2),_typescript.default.isIfStatement(s)&&(o+=getIfChildrenCount(s,t)),_typescript.default.isBlock(s)&&(o+=getBlockChildrenCount(s,t)),_typescript.default.isExpressionStatement(s)&&_typescript.default.isCallExpression(s.expression))for(var i=s.expression;i.expression;)_typescript.default.isCallExpression(i)&&_typescript.default.isIdentifier(i.expression)&&!isForEachComponent(i)&&isComponent(i,t)&&(o+=1,r+1<n&&_typescript.default.isBlock(e.statements[r+1])&&++r),i=i.expression;if(1<o)break}return o}function isComponent(e,t){return!(!_typescript.default.isIdentifier(e.expression)||!t.has(e.expression.escapedText.toString()))}function isForEachComponent(e){if(_typescript.default.isIdentifier(e.expression)){e=e.expression.escapedText.toString();return e===_pre_define.COMPONENT_FOREACH||e===_pre_define.COMPONENT_LAZYFOREACH}return!1}function getIfChildrenCount(e,t){return Math.max(getStatementCount(e.thenStatement,t),getStatementCount(e.elseStatement,t))}function getStatementCount(e,t){var o=0;return e&&(_typescript.default.isBlock(e)?o=getBlockChildrenCount(e,t):_typescript.default.isIfStatement(e)?o=getIfChildrenCount(e,t):_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&isForEachComponent(e.expression)?o=2:_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&!isForEachComponent(e.expression)&&isComponent(e.expression,t)&&(o=1)),o}function checkSpecificChildComponent(e,t,o,n){var r;_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression)&&hasNonspecificChild(e,t)&&(r=e.expression.expression.escapedText.toString(),t=e.expression.expression.getStart(),e=Array.from(_component_map.SPECIFIC_CHILD_COMPONENT.get(r)).join(" and "),e="The component '".concat(r,"' can only have the child component ").concat(e,"."),(0,_utils.addLog)(_utils.LogType.ERROR,e,t,n,o))}function hasNonspecificChild(e,t){var o=e.expression.expression.escapedText.toString(),n=getNextNode(e),e=!1;if(_component_map.SPECIFIC_CHILD_COMPONENT.has(o)&&n&&(e=isNonspecificChildBlock(n,_component_map.SPECIFIC_CHILD_COMPONENT.get(o),t)))return e;return e}function isNonspecificChildBlock(e,t,o){if(e.statements)for(var n=e.statements.length,r=0;r<n;++r){var s=e.statements[r];if(_typescript.default.isIfStatement(s)&&isNonspecificChildIf(s,t,o))return!0;if(_typescript.default.isExpressionStatement(s)&&_typescript.default.isCallExpression(s.expression)&&isForEachComponent(s.expression)&&isNonspecificChildForEach(s.expression,t,o))return!0;if(_typescript.default.isBlock(s)&&isNonspecificChildBlock(s,t,o))return!0;if(_typescript.default.isExpressionStatement(s)&&_typescript.default.isCallExpression(s.expression))for(var i=s.expression;i.expression;){if(_typescript.default.isCallExpression(i)&&_typescript.default.isIdentifier(i.expression)&&!isForEachComponent(i)&&isComponent(i,o)){var a=isNonspecificChildNonForEach(s.expression,t);if(a)return a;r+1<n&&_typescript.default.isBlock(e.statements[r+1])&&++r}i=i.expression}}return!1}function isNonspecificChildIf(e,t,o){return isNonspecificChildIfStatement(e.thenStatement,t,o)||isNonspecificChildIfStatement(e.elseStatement,t,o)}function isNonspecificChildForEach(e,t,o){if(_typescript.default.isCallExpression(e)&&e.arguments&&1<e.arguments.length&&_typescript.default.isArrowFunction(e.arguments[1])){e=e.arguments[1].body;if(!e)return!1;if(_typescript.default.isBlock(e)&&isNonspecificChildBlock(e,t,o))return!0;if(_typescript.default.isIfStatement(e)&&isNonspecificChildIf(e,t,o))return!0;if(_typescript.default.isCallExpression(e)&&isForEachComponent(e)&&isNonspecificChildForEach(e,t,o))return!0;if(_typescript.default.isCallExpression(e)&&!isForEachComponent(e)&&isComponent(e,o)&&isNonspecificChildNonForEach(e,t))return!0}return!1}function isNonspecificChildNonForEach(e,t){return!(!_typescript.default.isIdentifier(e.expression)||t.has(e.expression.escapedText.toString()))}function isNonspecificChildIfStatement(e,t,o){return!!e&&(!(!_typescript.default.isBlock(e)||!isNonspecificChildBlock(e,t,o))||(!(!_typescript.default.isIfStatement(e)||!isNonspecificChildIf(e,t,o))||(!!(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&isForEachComponent(e.expression)&&isNonspecificChildForEach(e.expression,t,o))||!!(_typescript.default.isExpressionStatement(e)&&_typescript.default.isCallExpression(e.expression)&&!isForEachComponent(e.expression)&&isComponent(e.expression,o)&&isNonspecificChildNonForEach(e.expression,t)))))}function collectComponentProps(e){var t=e.name.getText(),e=getComponentSet(e);propertyCollection.set(t,e.propertys),stateCollection.set(t,e.states),linkCollection.set(t,e.links),propCollection.set(t,e.props),regularCollection.set(t,e.regulars),storagePropCollection.set(t,e.storageProps),storageLinkCollection.set(t,e.storageLinks),provideCollection.set(t,e.provides),consumeCollection.set(t,e.consumes),objectLinkCollection.set(t,e.objectLinks)}function getComponentSet(e){var t=new Set,o=new Set,n=new Set,r=new Set,s=new Set,i=new Set,a=new Set,c=new Set,p=new Set,l=new Set;return traversalComponentProps(e,t,s,o,n,r,i,a,c,p,l),{propertys:t,regulars:s,states:o,links:n,props:r,storageProps:i,storageLinks:a,provides:c,consumes:p,objectLinks:l}}function traversalComponentProps(e,r,s,i,a,c,p,l,u,d,_){var C,f=this,m=!0;e.members&&(C=new Set,e.members.forEach(function(e){if(_newArrowCheck(this,f),_typescript.default.isPropertyDeclaration(e)&&_typescript.default.isIdentifier(e.name)){var t=e.name.getText();if(r.add(t),e.decorators&&e.decorators.length){m=!1;for(var o=0;o<e.decorators.length;o++){var n=e.decorators[o].getText().replace(/\(.*\)$/,"").trim();_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(n)&&(dollarCollection.add("$"+t),collectionStates(n,t,i,a,c,p,l,u,d,_))}}else s.add(t)}_typescript.default.isMethodDeclaration(e)&&e.name&&_typescript.default.isIdentifier(e.name)&&C.add(e.name.getText())}.bind(this)),classMethodCollection.set(e.name.getText(),C)),isStaticViewCollection.set(e.name.getText(),m)}function collectionStates(e,t,o,n,r,s,i,a,c,p){switch(e){case _pre_define.COMPONENT_STATE_DECORATOR:o.add(t);break;case _pre_define.COMPONENT_LINK_DECORATOR:n.add(t);break;case _pre_define.COMPONENT_PROP_DECORATOR:r.add(t);break;case _pre_define.COMPONENT_STORAGE_PROP_DECORATOR:s.add(t);break;case _pre_define.COMPONENT_STORAGE_LINK_DECORATOR:i.add(t);break;case _pre_define.COMPONENT_PROVIDE_DECORATOR:a.add(t);break;case _pre_define.COMPONENT_CONSUME_DECORATOR:c.add(t);break;case _pre_define.COMPONENT_OBJECT_LINK_DECORATOR:p.add(t)}}function sourceReplace(e,t){var o=this,n=e,e=[];return{content:n=processSystemApi(n=preprocessExtend(n=n.replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b.+\\{","g"),function(e){return _newArrowCheck(this,o),e=e.replace(new RegExp("\\b"+_pre_define.STRUCT+"\\b","g"),"".concat(_pre_define.CLASS," ")),"".concat(e," constructor(").concat(_pre_define.COMPONENT_CONSTRUCTOR_ID,"?, ").concat(_pre_define.COMPONENT_CONSTRUCTOR_PARENT,"?, ").concat(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS,"?) {}")}.bind(this)),t,e)),log:e}}function preprocessExtend(t,o,n){try{for(var r,s=(r=parser.parse(t)).content,e=0;e<r.collect_extend.component.length;e++)collectExtend(r.collect_extend.component[e],r.collect_extend.functionName[e],r.collect_extend.parameters[e])}catch(e){n.push({type:_utils.LogType.ERROR,message:parser.SyntaxError.buildMessage((r=e).expected,e.found),line:e.location.start.line,column:e.location.start.column,fileName:o}),s=t}if(r.error_otherParsers)for(var i=0;i<r.error_otherParsers.length;i++)n.push({type:_utils.LogType.ERROR,message:r.error_otherParsers[i].errMessage,line:r.error_otherParsers[i].errPosition.line,column:r.error_otherParsers[i].errPosition.column,fileName:o});return s}function collectExtend(e,t,o){o=o?o.split(",").length:0;_component_map.BUILDIN_STYLE_NAMES.add(t),_component_map.EXTEND_ATTRIBUTE.has(e)?_component_map.EXTEND_ATTRIBUTE.get(e).add({attribute:t,parameterCount:o}):_component_map.EXTEND_ATTRIBUTE.set(e,new Set([{attribute:t,parameterCount:o}]))}function processSystemApi(e){var a=this;return e.replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,t,o,n,r){_newArrowCheck(this,a);r=o||r;return"var ".concat(t||n,' = globalThis.requireNapi("').concat(r,'", true);')}.bind(this)).replace(/import\s+(.+)\s+from\s+['"]@(system|ohos)\.(\S+)['"]|import\s+(.+)\s*=\s*require\(\s*['"]@(system|ohos)\.(\S+)['"]\s*\)/g,function(e,t,o,n,r,s,i){_newArrowCheck(this,a);s=o||s,i=n||i,r=t||r;return moduleCollection.add("".concat(s,".").concat(i)),_pre_define.NATIVE_MODULE.has("".concat(s,".").concat(i))?e="var ".concat(r," = globalThis.requireNativeModule('").concat(s,".").concat(i,"')"):s===_pre_define.SYSTEM_PLUGIN?e="var ".concat(r," = isSystemplugin('").concat(i,"', '").concat(_pre_define.SYSTEM_PLUGIN,"') ? ")+"globalThis.systemplugin.".concat(i," : globalThis.requireNapi('").concat(i,"')"):s===_pre_define.OHOS_PLUGIN&&(e="var ".concat(r," = globalThis.requireNapi('").concat(i,"') || ")+"(isSystemplugin('".concat(i,"', '").concat(_pre_define.OHOS_PLUGIN,"') ? ")+"globalThis.ohosplugin.".concat(i," : isSystemplugin('").concat(i,"', '").concat(_pre_define.SYSTEM_PLUGIN,"') ")+"? globalThis.systemplugin.".concat(i," : undefined)")),e}.bind(this))}function resetComponentCollection(){componentCollection.entryComponent=null,componentCollection.previewComponent=null}exports.moduleCollection=moduleCollection;