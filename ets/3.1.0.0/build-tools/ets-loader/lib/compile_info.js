"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.props=exports.logger=exports.ResultStates=void 0;var _Compilation=_interopRequireDefault(require("webpack/lib/Compilation")),_JavascriptModulesPlugin=_interopRequireDefault(require("webpack/lib/javascript/JavascriptModulesPlugin")),_log4js=require("log4js"),_RawSource=_interopRequireDefault(require("webpack-sources/lib/RawSource")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_CachedSource=_interopRequireDefault(require("webpack-sources/lib/CachedSource")),_ConcatSource=_interopRequireDefault(require("webpack-sources/lib/ConcatSource")),_component_map=require("./component_map"),_process_ui_syntax=require("./process_ui_syntax"),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_member=require("./process_component_member"),_process_component_build=require("./process_component_build"),_main=require("../main"),_utils=require("./utils"),_pre_define=require("./pre_define");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}(0,_log4js.configure)({appenders:{ETS:{type:"stderr",layout:{type:"messagePassThrough"}}},categories:{default:{appenders:["ETS"],level:"info"}}});var logger=(0,_log4js.getLogger)("ETS");exports.logger=logger;var props=[];exports.props=props;var GLOBAL_COMMON_MODULE_CACHE='\nglobalThis["__common_module_cache__"] = globalThis["__common_module_cache__"] || {};\nglobalThis["webpackChunkcompilier"].forEach((item)=> {\n  Object.keys(item[1]).forEach((element) => {\n    globalThis["__common_module_cache__"][element] = null;\n  })\n});',ResultStates=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"mStats",void 0),_defineProperty(this,"mErrorCount",0),_defineProperty(this,"mWarningCount",0),_defineProperty(this,"warningCount",0),_defineProperty(this,"noteCount",0),_defineProperty(this,"red","[31m"),_defineProperty(this,"yellow","[33m"),_defineProperty(this,"blue","[34m"),_defineProperty(this,"reset","[39m"),_defineProperty(this,"modulePaths",new Set([]))}return _createClass(e,[{key:"apply",value:function(e){var n=this;e.hooks.compilation.tap("SourcemapFixer",function(e){var o=this;_newArrowCheck(this,n),e.hooks.afterProcessAssets.tap("SourcemapFixer",function(t){var r=this;_newArrowCheck(this,o),Reflect.ownKeys(t).forEach(function(e){_newArrowCheck(this,r),/\.map$/.test(e.toString())&&(t[e]._value=t[e]._value.toString().replace(".ets?entry",".ets"))}.bind(this))}.bind(this)),e.hooks.buildModule.tap("findModule",function(e){_newArrowCheck(this,o),/node_modules/.test(e.context)&&(e=_path.default.resolve(e.resourceResolveData.descriptionFileRoot,_pre_define.MODULE_SHARE_PATH),_fs.default.existsSync(e)&&this.modulePaths.add(e))}.bind(this))}.bind(this)),e.hooks.afterCompile.tap("copyFindModule",function(){var t=this;_newArrowCheck(this,n),this.modulePaths.forEach(function(e){_newArrowCheck(this,t),(0,_utils.circularFile)(e,_path.default.resolve(_main.projectConfig.buildPath,_pre_define.BUILD_SHARE_PATH))}.bind(this))}.bind(this)),e.hooks.compilation.tap("CommonAsset",function(e){var t=this;_newArrowCheck(this,n),e.hooks.processAssets.tap({name:"GLOBAL_COMMON_MODULE_CACHE",stage:_Compilation.default.PROCESS_ASSETS_STAGE_ADDITIONS},function(e){_newArrowCheck(this,t),e["commons.js"]?e["commons.js"]=new _CachedSource.default(new _ConcatSource.default(e["commons.js"],GLOBAL_COMMON_MODULE_CACHE)):e["vendors.js"]&&(e["vendors.js"]=new _CachedSource.default(new _ConcatSource.default(e["vendors.js"],GLOBAL_COMMON_MODULE_CACHE)))}.bind(this))}.bind(this)),e.hooks.compilation.tap("Require",function(e){var t=this;_newArrowCheck(this,n),_JavascriptModulesPlugin.default.getCompilationHooks(e).renderRequire.tap("renderRequire",function(e){return _newArrowCheck(this,t),'var commonCachedModule = globalThis["__common_module_cache__"] ? globalThis["__common_module_cache__"][moduleId]: null;\nif (commonCachedModule) { return commonCachedModule.exports; }\n'+e.replace("// Execute the module function",'if (globalThis["__common_module_cache__"] && moduleId.indexOf("?name=") < 0 && Object.keys(globalThis["__common_module_cache__"]).indexOf(moduleId) >= 0) {\n  globalThis["__common_module_cache__"][moduleId] = module;\n}')}.bind(this))}.bind(this)),e.hooks.done.tap("Result States",function(e){_newArrowCheck(this,n),this.mStats=e,this.warningCount=0,this.noteCount=0,this.mStats.compilation.errors&&(this.mErrorCount=this.mStats.compilation.errors.length),this.mStats.compilation.warnings&&(this.mWarningCount=this.mStats.compilation.warnings.length),props.push.apply(props,_toConsumableArray(_validate_ui_syntax.dollarCollection).concat(_toConsumableArray(_process_component_member.decoratorParamSet),_toConsumableArray(_component_map.BUILDIN_STYLE_NAMES))),this.printResult()}.bind(this)),_main.projectConfig.isPreview||e.hooks.compilation.tap("Collect Components And Modules",function(t){var r=this;_newArrowCheck(this,n),t.hooks.additionalAssets.tapAsync("Collect Components And Modules",function(e){_newArrowCheck(this,r),t.assets["./component_collection.txt"]=new _RawSource.default(Array.from(_process_component_build.appComponentCollection).join(",")),t.assets["./module_collection.txt"]=new _RawSource.default(0===_validate_ui_syntax.moduleCollection.size?"NULL":Array.from(_validate_ui_syntax.moduleCollection).join(",")),e()}.bind(this))}.bind(this))}},{key:"printResult",value:function(){var e,t;this.printWarning(),this.printError(),0<this.mErrorCount+this.warningCount+this.noteCount?(e="",t=0<this.mErrorCount?(e+="ERROR:".concat(this.mErrorCount),"FAIL "):"SUCCESS ",0<this.warningCount&&(e+=" WARN:".concat(this.warningCount)),0<this.noteCount&&(e+=" NOTE:".concat(this.noteCount)),logger.info(this.blue,"COMPILE RESULT:"+t+"{".concat(e,"}"),this.reset)):console.info(this.blue,"COMPILE RESULT:SUCCESS ",this.reset)}},{key:"printWarning",value:function(){if(0<this.mWarningCount){for(var e=this.mStats.compilation.warnings,t=e.length,r=0;r<t;r++){var o=e[r].message.replace(/^Module Warning\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"");/^NOTE/.test(o)?(this.noteCount++,logger.info(this.blue,o,this.reset,"\n")):(this.warningCount++,logger.warn(this.yellow,o.replace(/^WARN/,"ETS:WARN"),this.reset,"\n"))}this.mWarningCount>t&&(this.warningCount=this.warningCount+this.mWarningCount-t)}}},{key:"printError",value:function(){if(0<this.mErrorCount)for(var e,t,r,o=_toConsumableArray(this.mStats.compilation.errors),n=0;n<o.length;n++)o[n].issue?(t=o[n].issue.location?":".concat(o[n].issue.location.start.line,":").concat(o[n].issue.location.start.column):"",e=o[n].issue.file+t,t=o[n].issue.message,logger.error(this.red,"ETS:ERROR File: "+e,this.reset),logger.error(this.red,t,this.reset,"\n")):/BUILDERROR/.test(o[n].message)?(r=o[n].message.replace(/^Module Error\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"").replace(/^ERROR/,"ETS:ERROR"),this.printErrorMessage(r,!0,o[n])):(r="".concat(o[n].message.replace(/\[tsl\]\s*/,"").replace(/\u001b\[.*?m/g,"").replace(/\.ets\.ts/g,".ets").trim(),"\n"),r=this.filterModuleError(r).replace(/^ERROR in /,"ETS:ERROR File: ").replace(/\s{6}TS/g," TS").replace(/\(([0-9]+),([0-9]+)\)/,":$1:$2"),this.printErrorMessage(r,!1,o[n]))}},{key:"printErrorMessage",value:function(e,t,r){this.validateError(e)?t?logger.error(this.red,e+"\n",this.reset):logger.error(this.red,e,this.reset):(r=this.mStats.compilation.errors.indexOf(r),this.mStats.compilation.errors.splice(r,1),this.mErrorCount=this.mErrorCount-1)}},{key:"validateError",value:function(e){var t=/Property\s*'([_a-zA-Z0-9]+)' does not exist on type\s*'([_a-zA-Z0-9]+)'\./;return!(this.matchMessage(e,props,/Cannot find name\s*'(\$?\$?[_a-zA-Z0-9]+)'/)||this.matchMessage(e,_toConsumableArray(_validate_ui_syntax.componentCollection.customComponents),/'typeof\s*(\$?[_a-zA-Z0-9]+)' is not callable/)||this.matchMessage(e,props,/Property\s*'(\$[_a-zA-Z0-9]+)' does not exist on type/)||this.matchMessage(e,_component_map.EXTEND_ATTRIBUTE,t,!0)||this.matchMessage(e,_toConsumableArray(_component_map.STYLES_ATTRIBUTE),t))}},{key:"matchMessage",value:function(e,t,r){var o=this,n=3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(r.test(e)){r=e.match(r);if(n){if(r[1]&&r[2]&&t.has(r[2]))if(_toConsumableArray(t.get(r[2])).map(function(e){return _newArrowCheck(this,o),e.attribute}.bind(this)).includes(r[1]))return!0}else if(r[1]&&t.includes(r[1]))return!0}return!1}},{key:"filterModuleError",value:function(e){var t,r;return/You may need an additional loader/.test(e)&&_process_ui_syntax.transformLog&&_process_ui_syntax.transformLog.sourceFile&&(t=_process_ui_syntax.transformLog.sourceFile.fileName.replace(/.ts$/,""),(r=e.split("You may need an additional loader to handle the result of these loaders."))&&1<r.length&&r[1]&&(e="ERROR in ".concat(t,"\n The following syntax is incorrect.").concat(r[1]))),e}}]),e}();exports.ResultStates=ResultStates;