"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenAbcPlugin=void 0;var process=_interopRequireWildcard(require("child_process")),fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),_compile_info=require("./compile_info");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};r=_getRequireWildcardCache(r);if(r&&r.has(e))return r.get(e);var t,i,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((i=o?Object.getOwnPropertyDescriptor(e,t):null)&&(i.get||i.set)?Object.defineProperty(n,t,i):n[t]=e[t]);return n.default=e,r&&r.set(e,n),n}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}var output,arkDir,nodeJs,firstFileEXT="_.js",isWin=!1,isMac=!1,isDebug=!1,red="[31m",reset="[39m",GenAbcPlugin=function(){function n(e,r,t,i){_classCallCheck(this,n),output=e,arkDir=r,nodeJs=t,isDebug=i}return _createClass(n,[{key:"apply",value:function(e){var r=this;if(fs.existsSync(path.resolve(arkDir,"build-win")))isWin=!0;else if(fs.existsSync(path.resolve(arkDir,"build-mac")))isMac=!0;else if(!fs.existsSync(path.resolve(arkDir,"build")))return void _compile_info.logger.error(red,"ETS:ERROR find build fail",reset);e.hooks.emit.tap("GenAbcPlugin",function(i){var n=this;_newArrowCheck(this,r),Object.keys(i.assets).forEach(function(e){var r,t;_newArrowCheck(this,n),output&&".js"===path.extname(e)&&(r=i.assets[e].source(),t=e.replace(/\.js$/,firstFileEXT),writeFileSync(r,path.resolve(output,t),e))}.bind(this))}.bind(this))}}]),n}();function writeFileSync(e,r,t){var i=path.join(r,"..");fs.existsSync(i)&&fs.statSync(i).isDirectory()||mkDir(i),fs.writeFileSync(r,e),fs.existsSync(r)?js2abcFirst(r):_compile_info.logger.error(red,"ETS:ERROR Failed to convert file ".concat(t," to bin. ").concat(r," is lost"),reset)}function mkDir(e){var r=path.join(e,"..");fs.existsSync(r)&&!fs.statSync(r).isFile()||mkDir(r),fs.mkdirSync(e)}function js2abcFirst(r){var e="-r";isDebug&&(e+=" --debug");var t=path.join(arkDir,"build","src","index.js");isWin?t=path.join(arkDir,"build-win","src","index.js"):isMac&&(t=path.join(arkDir,"build-mac","src","index.js"));e="".concat(nodeJs,' --expose-gc "').concat(t,'" "').concat(r,'" ').concat(e);try{process.execSync(e)}catch(e){return void _compile_info.logger.error(red,"ETS:ERROR Failed to convert file ".concat(r," to abc "),reset)}fs.existsSync(r)&&fs.unlinkSync(r);e=r.replace(/\.js$/,".abc");fs.existsSync(e)?(r=e.replace(/_.abc$/,".abc"),fs.renameSync(e,r)):_compile_info.logger.error(red,"ETS:ERROR ".concat(e," is lost"),reset)}exports.GenAbcPlugin=GenAbcPlugin;