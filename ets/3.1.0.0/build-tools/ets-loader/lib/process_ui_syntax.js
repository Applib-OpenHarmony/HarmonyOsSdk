"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processUISyntax=processUISyntax,exports.resetLog=resetLog,exports.transformLog=void 0;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_validate_ui_syntax=require("./validate_ui_syntax"),_process_component_class=require("./process_component_class"),_process_import=_interopRequireDefault(require("./process_import")),_pre_define=require("./pre_define"),_utils=require("./utils"),_process_component_build=require("./process_component_build"),_component_map=require("./component_map"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,t=function(){};return{s:t,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,i=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){i=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(i)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}var transformLog=new _utils.FileLog;function processUISyntax(c){var e=this,u=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return function(n){var o,a=this;return _newArrowCheck(this,e),function(e){var t,r=this;return _newArrowCheck(this,a),o=_path.default.resolve(_path.default.dirname(e.fileName)),process.env.compiler===_pre_define.BUILD_ON?u||"app.ets.ts"!==_path.default.basename(e.fileName)&&/\.ets\.ts$/.test(e.fileName)?(collectComponents(e),transformLog.sourceFile=e,t=e,c&&(t=_typescript.default.visitEachChild(t,p,n)),e=createEntryNode(e,n),e=_typescript.default.visitEachChild(e,i,n),_component_map.GLOBAL_STYLE_FUNCTION.forEach(function(e,t){_newArrowCheck(this,r),_component_map.BUILDIN_STYLE_NAMES.delete(t)}.bind(this)),_component_map.GLOBAL_STYLE_FUNCTION.clear(),e):e=_typescript.default.visitEachChild(e,s,n):e}.bind(this);function i(e){var r=this;return _typescript.default.isImportDeclaration(e)||_typescript.default.isImportEqualsDeclaration(e)?(0,_process_import.default)(e,o,transformLog.errors):_typescript.default.isClassDeclaration(e)&&e.name&&_validate_ui_syntax.componentCollection.customComponents.has(e.name.getText())?(_validate_ui_syntax.componentCollection.currentClassName=e.name.getText(),e=(0,_process_component_class.processComponentClass)(e,n,transformLog.errors,c),_validate_ui_syntax.componentCollection.currentClassName=null,_component_map.INNER_STYLE_FUNCTION.forEach(function(e,t){_newArrowCheck(this,r),_component_map.BUILDIN_STYLE_NAMES.delete(t)}.bind(this)),_component_map.INNER_STYLE_FUNCTION.clear()):_typescript.default.isFunctionDeclaration(e)?(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_EXTEND_DECORATOR)?e=processExtend(e,transformLog.errors):(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_BUILDER_DECORATOR)&&e.name&&e.body&&_typescript.default.isBlock(e.body)?(_component_map.CUSTOM_BUILDER_METHOD.add(e.name.getText()),e=_typescript.default.factory.updateFunctionDeclaration(e,void 0,e.modifiers,e.asteriskToken,e.name,e.typeParameters,e.parameters,e.type,(0,_process_component_build.processComponentBlock)(e.body,!1,transformLog.errors))):(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_STYLES_DECORATOR)&&(0===e.parameters.length?e=void 0:transformLog.errors.push({type:_utils.LogType.ERROR,message:"@Styles can't have parameters.",pos:e.getStart()})):isResource(e)?e=processResourceData(e):isWorker(e)&&(e=processWorker(e)),_typescript.default.visitEachChild(e,i,n)}function s(e){return isResource(e)&&(e=processResourceData(e)),_typescript.default.visitEachChild(e,s,n)}function p(e){if(_typescript.default.isMethodDeclaration(e)&&e.name&&e.name.getText()===_pre_define.COMPONENT_BUILD_FUNCTION&&e.body&&_typescript.default.isBlock(e.body)){var t=c.getTypeChecker();return validateBody(e.body,t),e}return _typescript.default.visitEachChild(e,p,n)}}.bind(this)}function collectComponents(e){if(e.identifiers&&e.identifiers.size){var t,r=_createForOfIteratorHelper(e.identifiers.keys());try{for(r.s();!(t=r.n()).done;){var n=t.value;_component_map.JS_BIND_COMPONENTS.has(n)&&_process_component_build.appComponentCollection.add(n)}}catch(e){r.e(e)}finally{r.f()}}}function isResource(e){return _typescript.default.isCallExpression(e)&&_typescript.default.isIdentifier(e.expression)&&(e.expression.escapedText.toString()===_pre_define.RESOURCE||e.expression.escapedText.toString()===_pre_define.RESOURCE_RAWFILE)&&0<e.arguments.length}function processResourceData(e){if(_typescript.default.isStringLiteral(e.arguments[0])){if(e.expression.getText()===_pre_define.RESOURCE_RAWFILE)return createResourceParam(0,_pre_define.RESOURCE_TYPE.rawfile,[e.arguments[0]]);var t=e.arguments[0].text.trim().split(".");if(validateResourceData(t,_main.resources,e.arguments[0].getStart())){var r=_pre_define.RESOURCE_TYPE[t[1]];return createResourceParam(_main.resources[t[0]][t[1]][t[2]],r,Array.from(e.arguments).slice(1))}}return e}function createResourceParam(e,t,r){return _typescript.default.factory.createObjectLiteralExpression([_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createStringLiteral(_pre_define.RESOURCE_NAME_ID),_typescript.default.factory.createNumericLiteral(e)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createStringLiteral(_pre_define.RESOURCE_NAME_TYPE),_typescript.default.factory.createNumericLiteral(t)),_typescript.default.factory.createPropertyAssignment(_typescript.default.factory.createIdentifier(_pre_define.RESOURCE_NAME_PARAMS),_typescript.default.factory.createArrayLiteralExpression(r,!1))],!1)}function validateResourceData(e,t,r){if(3!==e.length)transformLog.errors.push({type:_utils.LogType.ERROR,message:"The input parameter is not supported.",pos:r});else if(t[e[0]])if(t[e[0]][e[1]]){if(t[e[0]][e[1]][e[2]])return!0;transformLog.errors.push({type:_utils.LogType.ERROR,message:"Value '".concat(e[2],"' does not exist on type 'typeof ").concat(e[1],"'."),pos:r})}else transformLog.errors.push({type:_utils.LogType.ERROR,message:"Value '".concat(e[1],"' does not exist on type 'typeof ").concat(e[0],"'."),pos:r});else transformLog.errors.push({type:_utils.LogType.ERROR,message:"The value of '".concat(e[0],"' is invalid."),pos:r});return!1}function isWorker(e){return _typescript.default.isNewExpression(e)&&_typescript.default.isPropertyAccessExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.name)&&e.expression.name.escapedText.toString()===_pre_define.WORKER_OBJECT}function processWorker(e){if(e.arguments.length&&_typescript.default.isStringLiteral(e.arguments[0])){var t=Array.from(e.arguments),r=e.arguments[0].text,r=_typescript.default.factory.createStringLiteral(r.replace(/\.ts$/,".js"));return t.splice(0,1,r),_typescript.default.factory.updateNewExpression(e,e.expression,e.typeArguments,t)}return e}function processExtend(e,t){var r=isExtendFunction(e);if(r){var n=[];return(0,_process_component_build.bindComponentAttr)(e.body.statements[0],_typescript.default.factory.createIdentifier(r),n,t),_typescript.default.factory.updateFunctionDeclaration(e,void 0,e.modifiers,e.asteriskToken,e.name,e.typeParameters,e.parameters,e.type,_typescript.default.factory.updateBlock(e.body,n))}}function isExtendFunction(e){var t=this;if(_typescript.default.isBlock(e.body)&&e.body.statements&&1===e.body.statements.length&&_typescript.default.isExpressionStatement(e.body.statements[0])&&_typescript.default.isCallExpression(e.body.statements[0].expression)&&_typescript.default.isIdentifier(e.name)){e=e.name.getText().split("__");if(3===e.length&&!e[0]&&_component_map.EXTEND_ATTRIBUTE.has(e[1]))if(_toConsumableArray(_component_map.EXTEND_ATTRIBUTE.get(e[1])).map(function(e){return _newArrowCheck(this,t),e.attribute}.bind(this)).includes(e[2]))return e[1]}}function createEntryNode(e,t){if(_validate_ui_syntax.componentCollection.entryComponent){var r=createEntryFunction(_validate_ui_syntax.componentCollection.entryComponent,t);return t.factory.updateSourceFile(e,[].concat(_toConsumableArray(e.statements),[r]))}if(_validate_ui_syntax.componentCollection.previewComponent){r=createEntryFunction(_validate_ui_syntax.componentCollection.previewComponent,t);return t.factory.updateSourceFile(e,[].concat(_toConsumableArray(e.statements),[r]))}return e}function validateBody(e,p){var c=this;e.statements.length&&e.statements.forEach(function(e,t,r){if(_newArrowCheck(this,c),_typescript.default.isBlock(e)&&validateBody(e,p),t+2<r.length&&_typescript.default.isExpressionStatement(e)&&isAttributeBlockNode(e,r,t)&&_typescript.default.isCallExpression(e.expression)&&_typescript.default.isIdentifier(e.expression.expression))for(var n=e.expression.expression.getText(),o=p.getTypeAtLocation(e.expression),a=r[t+2];a;){if(_typescript.default.isCallExpression(a))if(_typescript.default.isPropertyAccessExpression(a.expression)){var i=a.expression.name.getStart(),s=a.expression.name.getText();validateSymbol(isPropertyExist(p,i,o,s,n),a.arguments,i,p)}else if(_typescript.default.isIdentifier(a.expression)){i=a.expression.getStart();s=a.expression.getText(),validateSymbol(isPropertyExist(p,i,o,s,n),a.arguments,i,p);break}a=a.expression}}.bind(this))}function validateSymbol(e,t,r,n){if(e&&e.valueDeclaration.parameters){var o=e.valueDeclaration.parameters,a=o.length,e=getMinLength(o);if(t.length<e||t.length>a){a=(a!==e?"TS2554: Expected ".concat(e,"-"):"TS2554: Expected ").concat(a," arguments, but got ").concat(t.length,".");transformLog.errors.push({type:_utils.LogType.ERROR,message:a,pos:r})}else for(var i=0;i<o.length;i++)validatePropertyType(o[i],t[i],n)}}function getMinLength(e){var t=this,r=e.length;return e.forEach(function(e){_newArrowCheck(this,t),void 0!==e.questionToken&&r--}.bind(this)),r}function isPropertyExist(e,t,r,n,o){r=e.getPropertyOfType(r,n);return r||(transformLog.errors.push({type:_utils.LogType.ERROR,message:"TS2339: Property '".concat(n,"' does not exist on type '").concat(o,"'."),pos:t}),null)}function validatePropertyType(e,t,r){var n=r.getTypeAtLocation(t),o=r.getTypeAtLocation(e.type),e=r.getBaseTypeOfLiteralType(r.getTypeAtLocation(t)).intrinsicName||r.typeToString(n);r.isTypeAssignableTo(n,o)||generateArgumentLog(t,e,r.typeToString(o))}function generateArgumentLog(e,t,r){transformLog.errors.push({type:_utils.LogType.ERROR,message:"TS2345: Argument of type '".concat(t,"' is not assignable to parameter of type '").concat(r,"'."),pos:e.getStart()})}function isAttributeBlockNode(e,t,r){var n=t[r+2];return _component_map.BUILDIN_CONTAINER_COMPONENT.has((0,_process_component_build.getName)(e))&&_typescript.default.isBlock(t[r+1])&&_typescript.default.isExpressionStatement(n)&&(0,_process_component_build.isAttributeNode)(n)}function createEntryFunction(e,t){return t.factory.createExpressionStatement(t.factory.createCallExpression(t.factory.createIdentifier(_pre_define.PAGE_ENTRY_FUNCTION_NAME),void 0,[t.factory.createNewExpression(t.factory.createIdentifier(e),void 0,[t.factory.createStringLiteral((++_utils.componentInfo.id).toString()),t.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_UNDEFINED),t.factory.createObjectLiteralExpression([],!1)])]))}function resetLog(){transformLog.errors=[]}exports.transformLog=transformLog;